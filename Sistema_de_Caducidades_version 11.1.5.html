<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Caducidades</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --accent: #0f3b4a;
            --light-accent: #184a5f;
            --danger: #c33;
            --success: #0a6;
            --warning: #e65100;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        header h1 {
            margin: 0;
            font-size: 22px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: 0;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: var(--light-accent);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #a22;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #084;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #c44100;
        }
        
        .search-filter {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-filter input, .search-filter select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            min-width: 200px;
            font-size: 14px;
        }
        
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .card h3 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 2px solid var(--light-accent);
            padding-bottom: 10px;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .family-tag {
            background: #e6f7ff;
            color: #0070c0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .location-tag {
            background: #fff0e6;
            color: #e65100;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .status-expired {
            background: #ffebee;
            color: var(--danger);
        }
        
        .status-warning {
            background: #fff8e1;
            color: var(--warning);
        }
        
        .status-ok {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        th, td {
            border: 1px solid #e6eef2;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f3f6f8;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7fb;
        }
        
        .editor {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
            color: var(--accent);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 59, 74, 0.1);
        }
        
        .inline-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .inline-form .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 150px;
        }
        
        .codes-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .code-pill {
            background: #eef;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .code-pill span {
            cursor: pointer;
            font-weight: bold;
            color: #555;
        }
        
        .code-pill span:hover {
            color: var(--danger);
        }
        
        .hidden {
            display: none;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .dashboard-card h3 {
            margin-top: 0;
            color: var(--accent);
            font-size: 16px;
        }
        
        .dashboard-card .value {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .dashboard-card .link {
            font-size: 12px;
            color: var(--accent);
            margin-top: 10px;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .dashboard-card:hover .link {
            opacity: 1;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .editor-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .ranges-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .range-item {
            background: #f3f6f8;
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-item input {
            margin: 0;
        }
        
        .lot-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 2fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .lot-row input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .codes-display {
            font-size: 13px; 
            color: #666; 
            margin-top: 6px;
            background: #f8f8f8;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .file-upload-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .file-format-info {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .file-format-info ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .file-format-info li {
            margin-bottom: 8px;
        }
        
        .file-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .file-input-wrapper input[type="file"] {
            flex: 1;
            padding: 12px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            min-width: 300px;
        }
        
        .import-summary {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            background: #e8f5e9;
        }
        
        .import-summary.error {
            background: #ffebee;
        }
        
        .auto-save-info {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .auto-save-info .icon {
            font-size: 24px;
            color: #1565c0;
        }
        
        .save-notification {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: var(--accent);
            border-bottom: 2px solid var(--light-accent);
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        /* Nuevos estilos para el modal de guardado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .format-selector {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .format-selector label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .format-selector input[type="radio"] {
            margin-right: 10px;
        }
        
        /* Estilos para la secci贸n de surtido */
        .surtido-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .surtido-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }
        
        .surtido-list {
            margin-top: 20px;
        }
        
        .surtido-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .surtido-item:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .surtido-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .surtido-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #e8f5e9;
        }
        
        .surtido-result.error {
            background: #ffebee;
        }
        
        .surtido-result.warning {
            background: #fff8e1;
        }
        
        .lote-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .cantidad-inputs {
            display: flex;
            gap: 10px;
        }
        
        .cantidad-inputs .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .surtido-nota {
            margin-top: 15px;
        }
        
        .surtido-historial {
            margin-top: 30px;
        }
        
        .historial-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .historial-item:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .historial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .historial-fecha {
            font-weight: bold;
            color: var(--accent);
        }
        
        .historial-destino {
            font-style: italic;
            color: #666;
        }
        
        /* Nuevos estilos para gesti贸n de destinos */
        .destinos-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .destinos-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .destino-pill {
            background: #eef;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .destino-pill span {
            cursor: pointer;
            font-weight: bold;
            color: #555;
        }
        
        .destino-pill span:hover {
            color: var(--danger);
        }
        
        .destino-autocomplete {
            position: relative;
        }
        
        .destino-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .destino-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .destino-suggestion:hover {
            background: #f5f5f5;
        }
        
        .destino-suggestion:last-child {
            border-bottom: none;
        }
        
        .family-location-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        /* Nuevo estilo para el autocomplete de proveedores */
        .proveedor-autocomplete {
            position: relative;
        }
        
        .proveedor-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .proveedor-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .proveedor-suggestion:hover {
            background: #f5f5f5;
        }
        
        .proveedor-suggestion:last-child {
            border-bottom: none;
        }
        
        /* Nuevos estilos para mostrar conversi贸n de lotes */
        .lote-conversion-info {
            font-size: 12px;
            color: #e65100;
            margin-top: 4px;
            background: #fff8e1;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #ff9800;
            grid-column: 1 / -1;
        }
        
        .lote-converted {
            background-color: #f9f9f9;
            border-left: 3px solid #4caf50;
        }
        
        .existencias-conversion {
            font-size: 13px;
            color: #2e7d32;
            margin-top: 4px;
            font-weight: bold;
            background: #e8f5e9;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-controls .btn {
                margin-bottom: 8px;
            }
            
            .search-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .product-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .inline-form {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .inline-form .form-group {
                width: 100%;
            }
            
            .lot-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .surtido-form {
                grid-template-columns: 1fr;
            }
            
            .surtido-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .cantidad-inputs {
                flex-direction: column;
            }
            
            .historial-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .family-location-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN / AUTH FULLSCREEN MODAL (MODIFICADO) -->
    <div class="modal" id="loginModalVisual" style="display:flex;">
        <div class="modal-content" style="max-width:420px;">
            <h3 style="margin-top:0;">Iniciar sesi贸n</h3>
            <div class="form-group">
                <label>Usuario</label>
                <input type="text" id="loginUserVisual" placeholder="Usuario">
            </div>
            <div class="form-group">
                <label>Contrase帽a</label>
                <input type="password" id="loginPassVisual" placeholder="Contrase帽a">
            </div>
            <div id="loginErrorVisual" style="color:#c33; margin-top:6px; display:none;"></div>
            <div class="modal-buttons" style="margin-top:12px;">
                <button class="btn btn-danger" onclick="handleLogout()">Salir</button>
                <button class="btn btn-success" onclick="handleLogin()">Entrar</button>
            </div>
            <!-- SE ELIMIN LA LNEA CON LOS DATOS DEL ADMIN POR DEFECTO -->
        </div>
    </div>
    <!-- END LOGIN MODAL -->

    
<header>
        <h1>Control de Caducidades</h1>
        <div class="header-controls">
            <button id="btnInicio" class="btn" onclick="showSection('dashboard')">Inicio</button>
            <button id="btnProductos" class="btn" onclick="showSection('productos')">Productos</button>
            <button id="btnSurtido" class="btn" onclick="showSection('surtido')">Surtido</button>
            <button id="btnRecibo" class="btn" onclick="showSection('recibo')">Recibo de Mercanc铆a</button>
            <button id="btnReportes" class="btn" onclick="showSection('reportes')">Reportes</button>
            <button id="btnHistorial" class="btn" onclick="showSection('historialSurtido')">Historial Surtido</button>
            <button id="btnHistorialRecibos" class="btn" onclick="showSection('historialRecibos')">Historial Recibos</button>
            <button id="btnImportar" class="btn" onclick="showSection('importar')">Importar</button>
            <button id="btnConfiguracion" class="btn" onclick="showSection('configuracion')">Configuraci贸n</button>
            <button id="btnSaveExcel" class="btn btn-success" onclick="showSaveOptions()">Guardar en Excel</button>
            <button id="btnLogout" class="btn btn-danger" style="display:none; margin-left:10px;" onclick="handleLogout()">Cerrar sesi贸n</button>
        </div>
    </header>


    <div class="container">
        <!-- Dashboard Section -->
        <section id="dashboard">
            <h2 class="section-title">Inicio</h2>
            <div class="auto-save-info">
                <div class="icon"></div>
                <div>
                    <strong>Sistema de guardado 煤nico</strong><br>
                    Use el bot贸n "Guardar en Excel" para guardar todos los datos en un 煤nico archivo Excel.
                    Guarde este archivo en una carpeta espec铆fica para mantener sus datos seguros.
                </div>
            </div>
            
            <div class="card">
                <h3>Resumen General</h3>
                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="showSection('productos')">
                        <h3>Total de Productos</h3>
                        <div class="value" id="totalProductos">0</div>
                        <div class="link">Ver todos los productos</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showSection('productos')">
                        <h3>Total de Lotes</h3>
                        <div class="value" id="totalLotes">0</div>
                        <div class="link">Ver inventario completo</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showReporteFiltrado('expired')">
                        <h3>Productos Caducados</h3>
                        <div class="value" style="color: #c33;" id="productosCaducados">0</div>
                        <div class="link">Ver productos caducados</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>Productos Pr贸ximos a Caducar</h3>
                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="showReporteFiltrado('7days')">
                        <h3>Pr贸ximos 1-10 d铆as</h3>
                        <div class="value" style="color: #e65100;" id="proximos10Dias">0</div>
                        <div class="link">Ver reporte detallado</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showReporteFiltrado('15days')">
                        <h3>Pr贸ximos 15 d铆as</h3>
                        <div class="value" style="color: #ff9800;" id="proximos15Dias">0</div>
                        <div class="link">Ver reporte detallado</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showReporteFiltrado('1month')">
                        <h3>Pr贸ximos 1 mes</h3>
                        <div class="value" style="color: #ffa726;" id="proximos1Mes">0</div>
                        <div class="link">Ver reporte detallado</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showReporteFiltrado('2months')">
                        <h3>Pr贸ximos 2 meses</h3>
                        <div class="value" style="color: #ffb74d;" id="proximos2Meses">0</div>
                        <div class="link">Ver reporte detallado</div>
                    </div>
                    
                    <div class="dashboard-card" onclick="showReporteFiltrado('3months')">
                        <h3>Pr贸ximos 3 meses</h3>
                        <div class="value" style="color: #ffcc80;" id="proximos3Meses">0</div>
                        <div class="link">Ver reporte detallado</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Productos Section -->
        <section id="productos" class="hidden">
            <h2 class="section-title">Gesti贸n de Productos</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="nuevoProducto()">+ Nuevo Producto</button>
            </div>
            
            <!-- Editor de Productos en la parte superior -->
            <div id="editorPanel" class="editor hidden">
                <div class="editor-header">
                    <h3>Editar / Crear producto</h3>
                    <div class="editor-actions">
                        <button class="btn btn-success" onclick="saveProduct()">Guardar</button>
                        <button class="btn btn-danger" onclick="deleteProduct()" id="deleteBtn">Eliminar</button>
                        <button class="btn" onclick="closeEditor()">Cerrar</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>C贸digos de referencia</label>
                    <div class="codes-list" id="codesList"></div>
                    <div class="inline-form">
                        <div class="form-group">
                            <input id="newCodeInput" placeholder="Agregar c贸digo...">
                        </div>
                        <button class="btn" onclick="addCode()">Agregar</button>
                    </div>
                </div>
                
                <div class="inline-form">
                    <div class="form-group">
                        <label>Familia</label>
                        <select id="familySelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Nueva familia</label>
                        <input id="newFamilyInput" placeholder="Agregar familia...">
                    </div>
                    <button class="btn" onclick="addFamily()">Agregar</button>
                </div>
                
                <!-- NUEVO CAMPO: Ubicaci贸n en Almac茅n -->
                <div class="inline-form">
                    <div class="form-group">
                        <label>Ubicaci贸n en Almac茅n</label>
                        <input id="editUbicacion" type="text" placeholder="Ejemplo: G1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descripci贸n</label>
                    <input id="editDesc" type="text">
                </div>
                
                <div class="inline-form">
                    <div class="form-group">
                        <label>Factor</label>
                        <input id="editFactor" type="text" placeholder="Ejemplo: 12 / 200ML">
                    </div>
                    <div class="form-group">
                        <label>Tipo de producto</label>
                        <select id="editTipoProducto">
                            <option value="piezas">Por Piezas</option>
                            <option value="caja">Por Caja</option>
                            <option value="granel">A Granel (Kilos/Gramos)</option>
                        </select>
                    </div>
                </div>
                
                <h4>Lotes (puedes agregar y editar varios)</h4>
                <div id="lotsContainer"></div>
                
                <div class="inline-form">
                    <div class="form-group">
                        <label>Cajas</label>
                        <input id="lot_cajas" type="number" placeholder="Cajas" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label id="piezasLabel">Piezas</label>
                        <input id="lot_piezas" type="number" placeholder="Piezas" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Fecha caducidad</label>
                        <input id="lot_fecha" type="date">
                    </div>
                    <div class="form-group">
                        <label>Fecha contado</label>
                        <input id="lot_contado" type="date">
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <input id="lot_notas" type="text" placeholder="Notas internas">
                    </div>
                    <button class="btn" onclick="addLot()">Agregar lote</button>
                </div>
            </div>
            
            <div class="search-filter">
                <div>
                    <label for="familyFilter">Filtrar por familia:</label>
                    <select id="familyFilter" onchange="renderInventory()">
                        <option value="">Todas las familias</option>
                    </select>
                </div>
                <div>
                    <label for="globalSearch">Buscar:</label>
                    <input id="globalSearch" type="text" placeholder="C贸digo or descripci贸n..." oninput="renderInventory()">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button class="btn" onclick="clearFamilyFilter()">Quitar filtro</button>
                </div>
            </div>
            
            <div id="inventoryList"></div>
            <div class="small">Total de productos: <span id="totalCount">0</span></div>
        </section>

        <!-- Nueva Secci贸n de Surtido -->
        <section id="surtido" class="hidden">
            <h2 class="section-title">Surtido de Mercanc铆a</h2>
            
            <div class="surtido-container">
                <h3>Agregar productos al surtido</h3>
                
                <div class="surtido-form">
                    <div class="form-group">
                        <label for="surtidoProductSearch">Buscar producto</label>
                        <input type="text" id="surtidoProductSearch" placeholder="C贸digo o descripci贸n..." oninput="filterSurtidoProducts()">
                    </div>
                    
                    <div class="form-group">
                        <label for="surtidoProductSelect">Producto</label>
                        <select id="surtidoProductSelect" onchange="updateSurtidoProductInfo()">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    
                    <div class="cantidad-inputs">
                        <div class="form-group">
                            <label for="surtidoCajas">Cajas</label>
                            <input type="number" id="surtidoCajas" min="0" value="0" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="surtidoPiezas">Piezas</label>
                            <input type="number" id="surtidoPiezas" min="0" value="0" step="1">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addToSurtidoList()">Agregar al surtido</button>
                </div>
                
                <div id="surtidoProductInfo" class="codes-display">
                    Seleccione un producto para ver su informaci贸n
                </div>
                
                <div class="surtido-nota">
                    <div class="form-group destino-autocomplete">
                        <label for="surtidoDestino">Destino del surtido</label>
                        <input type="text" id="surtidoDestino" placeholder="Escriba o seleccione un destino..." 
                               oninput="filterDestinos()" onfocus="showDestinoSuggestions()">
                        <div class="destino-suggestions" id="destinoSuggestions"></div>
                    </div>
                    <div class="inline-form">
                        <div class="form-group">
                            <input type="text" id="nuevoDestinoInput" placeholder="Nuevo destino...">
                        </div>
                        <button class="btn" onclick="agregarDestino()">Agregar Destino</button>
                    </div>
                </div>
                
                <div class="surtido-list" id="surtidoList">
                    <!-- Aqu铆 se mostrar谩n los productos agregados al surtido -->
                </div>
                
                <div class="surtido-actions">
                    <button class="btn btn-success" onclick="processSurtido()">Procesar Surtido</button>
                    <button class="btn" onclick="exportSurtidoToExcel()">Exportar Lista de Surtido</button>
                    <button class="btn btn-danger" onclick="clearSurtidoList()">Limpiar Lista</button>
                </div>
                
                <div id="surtidoResult"></div>
            </div>
            
            <!-- SECCIN DE GESTIN DE DESTINOS ELIMINADA (se movi贸 a Configuraci贸n) -->
            
            <div class="card">
                <h3>Instrucciones</h3>
                <p>1. Busque un producto por c贸digo de barras o descripci贸n</p>
                <p>2. Seleccione el producto de la lista desplegable</p>
                <p>3. Ingrese la cantidad a surtir (cajas y/o piezas)</p>
                <p>4. Seleccione o agregue un destino del surtido (gesti贸n en Configuraci贸n)</p>
                <p>5. Haga clic en "Agregar al surtido"</p>
                <p>6. Repita para todos los productos necesarios</p>
                <p>7. Haga clic en "Procesar Surtido" para restar del inventario</p>
                <p><strong>Nota:</strong> El sistema surtir谩 primero de los lotes con fecha de caducidad m谩s pr贸xima</p>
            </div>
        </section>

        <!-- Nueva Secci贸n de Recibo de Mercanc铆a -->
        <section id="recibo" class="hidden">
            <h2 class="section-title">Recibo de Mercanc铆a</h2>
            
            <div class="surtido-container">
                <h3>Agregar productos al recibo</h3>
                
                <div class="surtido-form">
                    <div class="form-group">
                        <label for="reciboProductSearch">Buscar producto</label>
                        <input type="text" id="reciboProductSearch" placeholder="C贸digo o descripci贸n..." oninput="filterReciboProducts()">
                    </div>
                    
                    <div class="form-group">
                        <label for="reciboProductSelect">Producto</label>
                        <select id="reciboProductSelect" onchange="updateReciboProductInfo()">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    
                    <div class="cantidad-inputs">
                        <div class="form-group">
                            <label for="reciboCajas">Cajas</label>
                            <input type="number" id="reciboCajas" min="0" value="0" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="reciboPiezas">Piezas</label>
                            <input type="number" id="reciboPiezas" min="0" value="0" step="1">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addToReciboList()">Agregar al recibo</button>
                </div>
                
                <div id="reciboProductInfo" class="codes-display">
                    Seleccione un producto para ver su informaci贸n
                </div>
                
                <div class="surtido-nota">
                    <div class="inline-form">
                        <div class="form-group">
                            <label for="numeroCompra">N煤mero de Compra *</label>
                            <input type="text" id="numeroCompra" placeholder="N煤mero de compra..." required>
                        </div>
                        <div class="form-group">
                            <label for="proveedor">Proveedor *</label>
                            <input type="text" id="proveedor" placeholder="Nombre del proveedor..." required>
                        </div>
                    </div>
                    <div class="inline-form">
                        <div class="form-group">
                            <label for="fechaCaducidadRecibo">Fecha Caducidad *</label>
                            <input type="date" id="fechaCaducidadRecibo" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaContadoRecibo">Fecha Contado</label>
                            <input type="date" id="fechaContadoRecibo">
                        </div>
                        <div class="form-group">
                            <label for="notasRecibo">Notas</label>
                            <input type="text" id="notasRecibo" placeholder="Notas adicionales...">
                        </div>
                    </div>
                </div>
                
                <div class="surtido-list" id="reciboList">
                    <!-- Aqu铆 se mostrar谩n los productos agregados al recibo -->
                </div>
                
                <div class="surtido-actions">
                    <button class="btn btn-success" onclick="processRecibo()">Procesar Recibo</button>
                    <button class="btn" onclick="exportReciboToExcel()">Exportar Lista de Recibo</button>
                    <button class="btn btn-danger" onclick="clearReciboList()">Limpiar Lista</button>
                </div>
                
                <div id="reciboResult"></div>
            </div>
        </section>

        <!-- Reportes Section -->
        <section id="reportes" class="hidden">
            <h2 class="section-title">Reportes de Caducidades</h2>
            
            <div class="card">
                <h3>Filtrar por rango de fechas</h3>
                <div class="ranges-container" id="rangesContainer"></div>
                <div class="controls">
                    <button class="btn" onclick="selectAllRanges()">Seleccionar todo</button>
                    <button class="btn" onclick="clearRanges()">Limpiar</button>
                    <button class="btn" onclick="exportReportToExcel()">Exportar Reporte</button>
                </div>
            </div>
            
            <div id="reportResult" style="margin-top: 20px;"></div>
        </section>

        <!-- Nueva Secci贸n de Historial de Surtido -->
        <section id="historialSurtido" class="hidden">
            <h2 class="section-title">Historial de Surtidos</h2>
            
            <div class="card">
                <h3>Filtrar historial</h3>
                <div class="search-filter">
                    <div>
                        <label for="fechaInicio">Fecha inicio:</label>
                        <input type="date" id="fechaInicio" onchange="filtrarHistorialSurtido()">
                    </div>
                    <div>
                        <label for="fechaFin">Fecha fin:</label>
                        <input type="date" id="fechaFin" onchange="filtrarHistorialSurtido()">
                    </div>
                    <div>
                        <label for="filtroDestino">Destino:</label>
                        <input type="text" id="filtroDestino" placeholder="Filtrar por destino..." oninput="filtrarHistorialSurtido()">
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="btn" onclick="limpiarFiltrosHistorial()">Limpiar filtros</button>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="exportHistorialSurtidoToExcel()">Exportar Historial a Excel</button>
            </div>
            
            <div id="historialSurtidoList" class="surtido-historial">
                <!-- Aqu铆 se mostrar谩 el historial de surtidos -->
            </div>
        </section>

        <!-- Nueva Secci贸n de Historial de Recibos -->
        <section id="historialRecibos" class="hidden">
            <h2 class="section-title">Historial de Recibos</h2>
            
            <div class="card">
                <h3>Filtrar historial</h3>
                <div class="search-filter">
                    <div>
                        <label for="fechaInicioRecibo">Fecha inicio:</label>
                        <input type="date" id="fechaInicioRecibo" onchange="filtrarHistorialRecibos()">
                    </div>
                    <div>
                        <label for="fechaFinRecibo">Fecha fin:</label>
                        <input type="date" id="fechaFinRecibo" onchange="filtrarHistorialRecibos()">
                    </div>
                    <div class="proveedor-autocomplete">
                        <label for="filtroProveedor">Proveedor:</label>
                        <input type="text" id="filtroProveedor" placeholder="Escriba o seleccione un proveedor..." 
                               oninput="filterProveedores(); filtrarHistorialRecibos()" 
                               onfocus="showProveedorSuggestions()">
                        <div class="proveedor-suggestions" id="proveedorSuggestions"></div>
                    </div>
                    <div>
                        <label for="filtroNumeroCompra">N掳 Compra:</label>
                        <input type="text" id="filtroNumeroCompra" placeholder="Filtrar por n煤mero..." oninput="filtrarHistorialRecibos()">
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="btn" onclick="limpiarFiltrosHistorialRecibos()">Limpiar filtros</button>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="exportHistorialRecibosToExcel()">Exportar Historial a Excel</button>
            </div>
            
            <div id="historialRecibosList" class="surtido-historial">
                <!-- Aqu铆 se mostrar谩 el historial de recibos -->
            </div>
        </section>

        <!-- Importar Section -->
        <section id="importar" class="hidden">
            <h2 class="section-title">Importar Productos desde Excel</h2>
            
            <div class="file-upload-container">
                <h3>Cargar archivo Excel</h3>
                
                <div class="format-selector">
                    <label>
                        <input type="radio" name="importFormat" value="basic" checked onchange="updateImportInstructions()">
                        Formato b谩sico (C贸digo, Descripci贸n, Factor, Familia)
                    </label>
                    <label>
                        <input type="radio" name="importFormat" value="full" onchange="updateImportInstructions()">
                        Formato completo (C贸digo, Descripci贸n, Factor, Familia, Ubicaci贸n, Tipo Producto, Cajas, Piezas, Fecha Caducidad, Fecha Contado, Notas)
                    </label>
                </div>
                
                <div class="file-format-info" id="formatInfo">
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong>, <strong>Factor</strong>, <strong>Familia</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Factor en la tercera columna (C)</li>
                        <li>Las familias en la cuarta columna (D)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                </div>
                
                <div class="file-input-wrapper">
                    <input type="file" id="excelFileInput" accept=".xlsx, .xls">
                    <button class="btn btn-success" onclick="importExcel()">Importar</button>
                </div>
                
                <div id="importResult"></div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="showSection('productos')">Volver a Productos</button>
                <button class="btn btn-warning" onclick="clearAllProducts()">Eliminar Todos los Productos</button>
                <button class="btn btn-success" onclick="showSaveOptions()">Guardar en Excel</button>
            </div>
        </section>

        <!-- Configuraci贸n Section -->
        <section id="configuracion" class="hidden">
            <h2 class="section-title">Configuraci贸n</h2>

            <div class="card">
                <h3>Uso de almacenamiento</h3>
                <p>Revise cu谩nta informaci贸n est谩 almacenada en el sistema.</p>
                <button class="btn btn-success" onclick="checkStorageUsage()">Ver uso de almacenamiento</button>
                <div id="storageUsageResult" style="margin-top: 15px; font-weight: bold; color: var(--accent);"></div>
            </div>

            <div class="card">
                <h3>Datos</h3>
                <p><strong>Creado por:</strong> Alexis Aldo Ilizaliturri Alarid</p>
                <p><strong>Departamento:</strong> ALFA INVENTARIOS</p>
                <p><strong>Empresa:</strong> SUPER RIVERA</p>
                <img src="logo-super-rivera1.jpg" alt="Logo Super Rivera" style="max-width: 300px; margin-top: 15px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; background: white;">
            </div>
        
            <div class="card" id="usersManagementCardVisual" style="margin-top:20px;">
                <h3>Gesti贸n de Usuarios</h3>
                <p>Solo visible para administradores. Administre usuarios, active/inactive, asigne permisos y elimine.</p>
                <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
                    <button class="btn btn-success" onclick="openCreateUserModal()">Crear usuario</button>
                    <button class="btn" onclick="renderUsersTableVisual()">Refrescar lista</button>
                </div>
                <div id="usersTableContainerVisual"></div>
            </div>

            <!-- Modal Crear/Editar Usuario (visual) -->
            <div class="modal" id="userModalVisual" style="display:none;">
                <div class="modal-content" style="max-width:600px;">
                    <h3 id="userModalTitle">Editar Usuario</h3>
                    <div class="editor">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="um_username" placeholder="Usuario">
                        </div>
                        <div class="form-group">
                            <label>Contrase帽a</label>
                            <input type="password" id="um_password" placeholder="Contrase帽a (dejar vac铆o para no cambiar)">
                        </div>
                        <div class="inline-form" style="gap:20px;">
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="um_estado">
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de usuario</label>
                                <select id="um_tipo">
                                    <!-- Las opciones se cargar谩n din谩micamente desde JavaScript -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Secci贸n para agregar nuevos tipos de usuario -->
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Agregar nuevo tipo de usuario</label>
                            <div class="inline-form">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" id="nuevoTipoUsuarioInput" placeholder="Ejemplo: Compras, Almac茅n...">
                                </div>
                                <button class="btn" onclick="agregarNuevoTipoUsuario()">Agregar Tipo</button>
                            </div>
                        </div>
                        
                        <div style="margin-top:12px;">
                            <label style="font-weight:bold;">Permisos de Acceso</label>
                            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:8px;">
                                <label><input type="checkbox" id="perm_inicio"> Inicio</label>
                                <label><input type="checkbox" id="perm_prod_ver"> Productos (Ver)</label>
                                <label><input type="checkbox" id="perm_prod_edit"> Productos (Editar)</label>
                                <label><input type="checkbox" id="perm_surtido"> Surtido</label>
                                <label><input type="checkbox" id="perm_recibo"> Recibo de Mercanc铆a</label>
                                <label><input type="checkbox" id="perm_reportes"> Reportes</label>
                                <label><input type="checkbox" id="perm_historial"> Historial</label>
                                <label><input type="checkbox" id="perm_importar"> Importar</label>
                                <label><input type="checkbox" id="perm_config"> Configuraci贸n</label>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
                            <button class="btn btn-danger" id="um_delete_btn" style="display:none;" onclick="deleteUserFromModal()">Eliminar Usuario</button>
                            <button class="btn" onclick="closeUserModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveUserFromModal()">Guardar Usuario</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gesti贸n de Tipos de Usuario -->
            <div class="card" id="tiposUsuarioCardVisual" style="margin-top:20px;">
                <h3>Gesti贸n de Tipos de Usuario</h3>
                <p>Administre los tipos de usuario disponibles en el sistema. Los tipos "admin" y "usuario" no se pueden eliminar.</p>
                
                <div class="inline-form" style="align-items:center; margin-bottom: 15px;">
                    <div class="form-group" style="flex:1; min-width:200px;">
                        <label>Nuevo tipo de usuario</label>
                        <input id="nuevoTipoUsuarioConfigInput" placeholder="Ejemplo: compras, almac茅n...">
                    </div>
                    <div style="display:flex; gap:10px; align-items:flex-end;">
                        <button class="btn" onclick="agregarTipoUsuarioDesdeConfig()">Agregar Tipo</button>
                    </div>
                </div>
                
                <div id="tiposUsuarioList">
                    <!-- Aqu铆 se mostrar谩n los tipos de usuario -->
                </div>
            </div>

            <div class="card" id="destinosConfigCardVisual" style="margin-top:20px;">
                <h3>Gesti贸n de Destinos</h3>
                <p>Administre la lista de destinos disponibles para los surtidos. Los cambios se reflejan inmediatamente en Surtido de Mercanc铆a.</p>
                <div class="inline-form" style="align-items:center;">
                    <div class="form-group" style="flex:1; min-width:200px;">
                        <label>Nuevo destino</label>
                        <input id="nuevoDestinoConfigInputVisual" placeholder="Agregar destino...">
                    </div>
                    <div style="display:flex; gap:10px; align-items:flex-end;">
                        <button class="btn" onclick="agregarDestinoDesdeConfigVisual()">Agregar</button>
                        <button class="btn" onclick="limpiarDestinosConfigVisual()">Eliminar todos</button>
                    </div>
                </div>
                <div id="destinosConfigListVisual" style="margin-top:12px;"></div>
            </div>
        </section>

    </div>

    <div class="save-notification" id="saveNotification">
        Datos guardados exitosamente en Control_Caducidades.xlsx
    </div>

    <!-- Modal para opciones de guardado -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <h3>Guardar en Excel</h3>
            <p>驴C贸mo desea guardar el archivo?</p>
            <div class="modal-buttons">
                <button class="btn" onclick="saveToExcel('new')">Guardar como nuevo</button>
                <button class="btn btn-success" onclick="saveToExcel('overwrite')">Sobrescribir existente</button>
                <button class="btn btn-danger" onclick="closeSaveModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Base de datos de productos
        let products = [
            {
                "codes": ["7509546686776"],
                "descripcion": "CAPRICE 200ML SH CONT/CASPA",
                "familia": "A1 SHAMPOO",
                "ubicacion": "G1", // NUEVO CAMPO
                "lotes": []
            },
            {
                "codes": ["7509546073033"],
                "descripcion": "CAPRICE 200ML SH ESP ACTI-CERAM",
                "familia": "A1 SHAMPOO",
                "ubicacion": "G1", // NUEVO CAMPO
                "lotes": []
            },
            {
                "codes": ["7509546073040"],
                "descripcion": "CAPRICE 200ML SH ESP BIOTINA",
                "familia": "A1 SHAMPOO",
                "ubicacion": "G1", // NUEVO CAMPO
                "lotes": []
            }
        ];

        let currentProductIndex = -1;
        let editingCodes = [];
        let editingLots = [];
        
        // Variables globales para el surtido
        let surtidoList = [];
        let allProductsForSurtido = [];
        let historialSurtidos = [];
        let destinos = ['Tienda 1', 'Tienda 2', 'Bodega Central', 'Sucursal Norte', 'Sucursal Sur'];

        // Variables globales para el recibo
        let reciboList = [];
        let historialRecibos = [];

        // ============================================
        // FUNCIONES PRINCIPALES DE CONVERSIN - CORREGIDAS
        // ============================================

        // Funci贸n para extraer el factor num茅rico de un string
        function extraerFactor(factorString) {
            if (!factorString) return 1;
            
            // Buscar n煤meros en el string
            const factorMatch = factorString.toString().match(/\d+/);
            return factorMatch ? parseInt(factorMatch[0]) : 1;
        }

        // Funci贸n CORREGIDA para convertir cantidades seg煤n el factor
        function convertirCantidadesSegunFactor(cajas, piezas, factor, tipoProducto) {
            // Si no hay factor definido o es producto a granel, no convertir
            if (!factor || tipoProducto === 'granel') {
                return { cajas: cajas, piezas: piezas };
            }
            
            const factorNum = extraerFactor(factor);
            
            if (isNaN(factorNum) || factorNum <= 0) {
                return { cajas: cajas, piezas: piezas };
            }
            
            // Convertir todo a piezas
            const totalPiezas = (cajas * factorNum) + piezas;
            
            // Recalcular cajas y piezas
            const nuevasCajas = Math.floor(totalPiezas / factorNum);
            const nuevasPiezas = totalPiezas % factorNum;
            
            return { cajas: nuevasCajas, piezas: nuevasPiezas };
        }

        // Funci贸n CORREGIDA para calcular existencias totales convertidas
        function calcularExistenciasTotales(product) {
            let totalCajas = 0;
            let totalPiezas = 0;
            
            if (product.lotes && product.lotes.length > 0) {
                product.lotes.forEach(lote => {
                    totalCajas += parseFloat(lote.cajas) || 0;
                    totalPiezas += parseFloat(lote.piezas) || 0;
                });
            }
            
            // Convertir seg煤n el factor para productos por piezas O por caja
            if ((product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') && product.factor) {
                const cantidadesConvertidas = convertirCantidadesSegunFactor(
                    totalCajas, 
                    totalPiezas, 
                    product.factor, 
                    product.tipoProducto
                );
                return {
                    cajas: cantidadesConvertidas.cajas,
                    piezas: cantidadesConvertidas.piezas
                };
            }
            
            return { cajas: totalCajas, piezas: totalPiezas };
        }

        // Inicializaci贸n
        window.onload = function() {
            console.log("Inicializando sistema...");
            
            // Cargar datos guardados o usar los predeterminados
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                try {
                    products = JSON.parse(savedProducts);
                    console.log("Productos cargados desde localStorage:", products.length);
                } catch (e) {
                    console.error("Error al cargar datos guardados:", e);
                    // Mantener los datos predeterminados si hay error
                    products = [
                        {
                            "codes": ["7509546686776"],
                            "descripcion": "CAPRICE 200ML SH CONT/CASPA",
                            "familia": "A1 SHAMPOO",
                            "ubicacion": "G1", // NUEVO CAMPO
                            "lotes": []
                        },
                        {
                            "codes": ["7509546073033"],
                            "descripcion": "CAPRICE 200ML SH ESP ACTI-CERAM",
                            "familia": "A1 SHAMPOO",
                            "ubicacion": "G1", // NUEVO CAMPO
                            "lotes": []
                        },
                        {
                            "codes": ["7509546073040"],
                            "descripcion": "CAPRICE 200ML SH ESP BIOTINA",
                            "familia": "A1 SHAMPOO",
                            "ubicacion": "G1", // NUEVO CAMPO
                            "lotes": []
                        }
                    ];
                }
            } else {
                console.log("No se encontraron productos guardados, usando datos predeterminados");
            }
            
            // Cargar historial de surtidos
            const savedHistorial = localStorage.getItem('historialSurtidos');
            if (savedHistorial) {
                try {
                    historialSurtidos = JSON.parse(savedHistorial);
                    console.log("Historial de surtidos cargado:", historialSurtidos.length);
                } catch (e) {
                    console.error("Error al cargar historial de surtidos:", e);
                    historialSurtidos = [];
                }
            }
            
            // Cargar historial de recibos
            const savedHistorialRecibos = localStorage.getItem('historialRecibos');
            if (savedHistorialRecibos) {
                try {
                    historialRecibos = JSON.parse(savedHistorialRecibos);
                    console.log("Historial de recibos cargado:", historialRecibos.length);
                } catch (e) {
                    console.error("Error al cargar historial de recibos:", e);
                    historialRecibos = [];
                }
            }
            
            // Cargar destinos guardados
            const savedDestinos = localStorage.getItem('destinosSurtido');
            if (savedDestinos) {
                try {
                    destinos = JSON.parse(savedDestinos);
                    console.log("Destinos cargados:", destinos.length);
                } catch (e) {
                    console.error("Error al cargar destinos:", e);
                    destinos = ['Tienda 1', 'Tienda 2', 'Bodega Central', 'Sucursal Norte', 'Sucursal Sur'];
                }
            }
            
            // Inicializar todas las secciones
            renderDashboard();
            populateFamilyFilter();
            populateFamilySelect();
            renderInventory();
            renderReports();
            renderDestinosList();
            
            // Mostrar la secci贸n de inicio por defecto
            showSection('dashboard');
            
            console.log("Sistema inicializado correctamente");
            
            // Agregar evento para actualizar la etiqueta cuando cambie el tipo de producto
            document.getElementById('editTipoProducto').addEventListener('change', updatePiezasLabel);
        };

        // Funci贸n para obtener texto del tipo de producto
        function getTipoProductoTexto(tipo) {
            switch(tipo) {
                case 'granel': return 'A Granel';
                case 'caja': return 'Por Caja';
                case 'piezas': return 'Por Piezas';
                default: return 'Por Piezas';
            }
        }

        // Funci贸n para obtener texto del tipo de producto para exportaci贸n
        function getTipoProductoExportacion(tipo) {
            switch(tipo) {
                case 'granel': return 'A Granel';
                case 'caja': return 'Por Caja';
                case 'piezas': return 'Por Piezas';
                default: return 'Por Piezas';
            }
        }

        // Funci贸n para actualizar la etiqueta seg煤n el tipo de producto
        function updatePiezasLabel() {
            const tipoProducto = document.getElementById('editTipoProducto').value;
            const piezasLabel = document.getElementById('piezasLabel');
            const piezasInput = document.getElementById('lot_piezas');
            
            if (tipoProducto === 'granel') {
                piezasLabel.textContent = 'Kilos/Gramos';
                piezasInput.placeholder = 'Kilos/Gramos';
                piezasInput.step = '0.001'; // Permitir decimales para productos a granel
            } else if (tipoProducto === 'caja') {
                piezasLabel.textContent = 'Piezas por Caja';
                piezasInput.placeholder = 'Piezas por Caja';
                piezasInput.step = '1'; // Solo n煤meros enteros para piezas por caja
            } else {
                piezasLabel.textContent = 'Piezas';
                piezasInput.placeholder = 'Piezas';
                piezasInput.step = '1'; // Solo n煤meros enteros para piezas
            }
        }

        // Funci贸n para actualizar los inputs de surtido seg煤n el tipo de producto
        function updateSurtidoInputs(tipoProducto) {
            const piezasInput = document.getElementById('surtidoPiezas');
            
            if (tipoProducto === 'granel') {
                piezasInput.step = '0.001'; // Permitir decimales para productos a granel
            } else {
                piezasInput.step = '1'; // Solo n煤meros enteros para piezas y cajas
            }
        }

        // Funci贸n para actualizar las instrucciones de importaci贸n seg煤n el formato seleccionado
        function updateImportInstructions() {
            const formatInfo = document.getElementById('formatInfo');
            const format = document.querySelector('input[name="importFormat"]:checked').value;
            
            if (format === 'basic') {
                formatInfo.innerHTML = `
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong>, <strong>Factor</strong>, <strong>Familia</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Factor en la tercera columna (C)</li>
                        <li>Las familias en la cuarta columna (D)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                `;
            } else {
                formatInfo.innerHTML = `
                    <p><strong>Formato requerido para el archivo Excel:</strong></p>
                    <ul>
                        <li>El archivo debe tener las columnas: <strong>C贸digo</strong>, <strong>Descripci贸n</strong>, <strong>Factor</strong>, <strong>Familia</strong>, <strong>Ubicaci贸n</strong>, <strong>Tipo Producto</strong>, <strong>Cajas</strong>, <strong>Piezas</strong>, <strong>Fecha Caducidad</strong>, <strong>Fecha Contado</strong>, <strong>Notas</strong></li>
                        <li>La primera fila debe contener los encabezados de columna</li>
                        <li>Los c贸digos deben estar en la primera columna (A)</li>
                        <li>Las descripciones en la segunda columna (B)</li>
                        <li>Factor en la tercera columna (C)</li>
                        <li>Las familias en la cuarta columna (D)</li>
                        <li>Ubicaci贸n en la quinta columna (E)</li>
                        <li>Tipo Producto en la sexta columna (F) - Valores: "piezas", "caja" o "granel"</li>
                        <li>Cajas en la s茅ptima columna (G)</li>
                        <li>Piezas en la octava columna (H)</li>
                        <li>Fecha Caducidad en la novena columna (I)</li>
                        <li>Fecha Contado en la d茅cima columna (J)</li>
                        <li>Notas en la und茅cima columna (K)</li>
                    </ul>
                    <p>Los productos importados se agregar谩n a los existentes, sin eliminarlos.</p>
                `;
            }
        }

        // Navegaci贸n entre secciones
        function showSection(sectionId) {
            console.log("Mostrando secci贸n:", sectionId);
            
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('section');
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar la secci贸n seleccionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Actualizar la secci贸n si es necesario
            if (sectionId === 'dashboard') {
                renderDashboard();
            } else if (sectionId === 'productos') {
                renderInventory();
            } else if (sectionId === 'reportes') {
                renderReports();
            } else if (sectionId === 'surtido') {
                populateSurtidoProductSelect();
                renderSurtidoList();
            } else if (sectionId === 'historialSurtido') {
                renderHistorialSurtido();
            } else if (sectionId === 'recibo') {
                populateReciboProductSelect();
                renderReciboList();
            } else if (sectionId === 'historialRecibos') {
                renderHistorialRecibos();
            } else if (sectionId === 'configuracion') {
                // Actualizar la lista de tipos de usuario cuando se entra a configuraci贸n
                setTimeout(() => {
                    renderTiposUsuarioList();
                }, 100);
            }
        }

        // Funci贸n para mostrar reportes filtrados desde el dashboard
        function showReporteFiltrado(rangeId) {
            // Mostrar la secci贸n de reportes
            showSection('reportes');
            
            // Seleccionar el rango espec铆fico
            setTimeout(() => {
                const checkbox = document.getElementById(rangeId);
                if (checkbox) {
                    checkbox.checked = true;
                    generateReport();
                }
            }, 100);
        }

        // Dashboard
        function renderDashboard() {
            // Calcular productos pr贸ximos a caducar en diferentes rangos
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Definir diferentes rangos de fechas
            const tenDays = new Date(today);
            tenDays.setDate(today.getDate() + 10);
            
            const fifteenDays = new Date(today);
            fifteenDays.setDate(today.getDate() + 15);
            
            const oneMonth = new Date(today);
            oneMonth.setMonth(today.getMonth() + 1);
            
            const twoMonths = new Date(today);
            twoMonths.setMonth(today.getMonth() + 2);
            
            const threeMonths = new Date(today);
            threeMonths.setMonth(today.getMonth() + 3);
            
            let expiringInTenDaysCount = 0;
            let expiringInFifteenDaysCount = 0;
            let expiringInOneMonthCount = 0;
            let expiringInTwoMonthsCount = 0;
            let expiringInThreeMonthsCount = 0;
            let expiredCount = 0;
            let totalLotes = 0;
            
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    totalLotes += product.lotes.length;
                    product.lotes.forEach(lote => {
                        if (lote.fecha) {
                            const expirationDate = new Date(lote.fecha);
                            expirationDate.setHours(0, 0, 0, 0);
                            
                            if (expirationDate < today) {
                                expiredCount++;
                            } else if (expirationDate <= tenDays) {
                                expiringInTenDaysCount++;
                            } else if (expirationDate <= fifteenDays) {
                                expiringInFifteenDaysCount++;
                            } else if (expirationDate <= oneMonth) {
                                expiringInOneMonthCount++;
                            } else if (expirationDate <= twoMonths) {
                                expiringInTwoMonthsCount++;
                            } else if (expirationDate <= threeMonths) {
                                expiringInThreeMonthsCount++;
                            }
                        }
                    });
                }
            });
            
            // Actualizar los valores en el dashboard
            document.getElementById('totalProductos').textContent = products.length;
            document.getElementById('totalLotes').textContent = totalLotes;
            document.getElementById('productosCaducados').textContent = expiredCount;
            document.getElementById('proximos10Dias').textContent = expiringInTenDaysCount;
            document.getElementById('proximos15Dias').textContent = expiringInFifteenDaysCount;
            document.getElementById('proximos1Mes').textContent = expiringInOneMonthCount;
            document.getElementById('proximos2Meses').textContent = expiringInTwoMonthsCount;
            document.getElementById('proximos3Meses').textContent = expiringInThreeMonthsCount;
        }

        // Inventario - Filtrado
        function populateFamilyFilter() {
            const familyFilter = document.getElementById('familyFilter');
            const families = [...new Set(products.map(p => p.familia))].sort();
            
            familyFilter.innerHTML = '<option value="">Todas las familias</option>';
            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                familyFilter.appendChild(option);
            });
        }

        function clearFamilyFilter() {
            document.getElementById('familyFilter').value = '';
            document.getElementById('globalSearch').value = '';
            renderInventory();
        }

        // Funci贸n para calcular meses y d铆as entre dos fechas
        function calculateMonthsAndDays(startDate, endDate) {
            // Asegurarse de que las fechas sean objetos Date v谩lidos
            if (!(startDate instanceof Date) || !(endDate instanceof Date)) {
                return { meses: 0, dias: 0 };
            }
            
            // Si la fecha ya pas贸, devolver valores negativos
            if (startDate > endDate) {
                const diffTime = startDate - endDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return { meses: 0, dias: -diffDays };
            }
            
            let meses = 0;
            let dias = 0;
            
            // Calcular meses
            let tempDate = new Date(startDate);
            while (tempDate < endDate) {
                tempDate.setMonth(tempDate.getMonth() + 1);
                if (tempDate <= endDate) {
                    meses++;
                } else {
                    tempDate.setMonth(tempDate.getMonth() - 1);
                    break;
                }
            }
            
            // Calcular d铆as restantes
            if (tempDate < endDate) {
                const diffTime = endDate - tempDate;
                dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }
            
            return { meses, dias };
        }

        // Funci贸n para determinar el estado de caducidad
        function getExpirationStatus(expirationDate) {
            if (!expirationDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const expDate = new Date(expirationDate);
            expDate.setHours(0, 0, 0, 0);
            
            const diffTime = expDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return '<span class="status-badge status-expired">CADUCADO</span>';
            }
            
            // Calcular meses y d铆as restantes
            const { meses, dias } = calculateMonthsAndDays(today, expDate);
            
            let statusText = '';
            if (meses === 0) {
                statusText = `${dias} ${dias === 1 ? 'd铆a' : 'd铆as'}`;
            } else if (dias === 0) {
                statusText = `${meses} ${meses === 1 ? 'mes' : 'meses'}`;
            } else {
                statusText = `${meses} ${meses === 1 ? 'mes' : 'meses'} y ${dias} ${dias === 1 ? 'd铆a' : 'd铆as'}`;
            }
            
            if (diffDays <= 7) {
                return `<span class="status-badge status-warning">PRXIMO (${statusText})</span>`;
            } else if (diffDays <= 30) {
                return `<span class="status-badge status-warning">EN ${statusText.toUpperCase()}</span>`;
            } else {
                return `<span class="status-badge status-ok">${statusText.toUpperCase()}</span>`;
            }
        }

        // Inventario - Renderizado
        
        function renderInventory() {
            const inventoryList = document.getElementById('inventoryList');
            const familyFilter = document.getElementById('familyFilter').value;
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();

            // Filtrar productos
            let filteredProducts = products;

            if (familyFilter) {
                filteredProducts = filteredProducts.filter(p => p.familia === familyFilter);
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    (p.codes || []).some(code => String(code).toLowerCase().includes(searchTerm)) ||
                    (p.descripcion || '').toLowerCase().includes(searchTerm)
                );
            }

            // Actualizar contador
            document.getElementById('totalCount').textContent = filteredProducts.length;

            // Renderizar lista
            inventoryList.innerHTML = '';

            if (filteredProducts.length === 0) {
                inventoryList.innerHTML = '<div class="card"><p>No se encontraron productos</p></div>';
                return;
            }

            filteredProducts.forEach((product) => {
                const productEl = document.createElement('div');
                productEl.className = 'card';

                // Encontrar la fecha m谩s pr贸xima a caducar
                let closestExpiration = null;
                if (product.lotes && product.lotes.length > 0) {
                    const today = new Date();
                    const validDates = product.lotes
                        .filter(lote => lote.fecha)
                        .map(lote => new Date(lote.fecha))
                        .filter(date => !isNaN(date.getTime()));

                    if (validDates.length > 0) {
                        closestExpiration = new Date(Math.min(...validDates.map(d => d.getTime())));
                    }
                }

                const statusBadge = closestExpiration ? getExpirationStatus(closestExpiration.toISOString().split('T')[0]) : '';

                // Obtener el 铆ndice real en el array 'products' para que editar apunte al producto correcto
                const originalIndex = products.indexOf(product);

                // Calcular existencias totales CONVERTIDAS - USANDO LA FUNCIN CORREGIDA
                const existencias = calcularExistenciasTotales(product);
                
                // Calcular total de piezas sin convertir para mostrar la conversi贸n
                let totalPiezasSinConvertir = 0;
                let totalCajasSinConvertir = 0;
                
                if (product.lotes && product.lotes.length > 0) {
                    product.lotes.forEach(lote => {
                        totalCajasSinConvertir += parseFloat(lote.cajas) || 0;
                        totalPiezasSinConvertir += parseFloat(lote.piezas) || 0;
                    });
                }

                productEl.innerHTML = `
                    <div class="product-header">
                        <div>
                            <strong>${product.descripcion || 'Sin descripci贸n'}</strong>
                            ${product.factor ? `<div style="font-size:13px;color:#666;">Factor: ${product.factor}</div>` : ''}
                            ${product.tipoProducto ? `<div style="font-size:13px;color:#666;">Tipo: ${getTipoProductoTexto(product.tipoProducto)}</div>` : ''}
                            <div class="codes-display">C贸digos: ${product.codes.join(', ')}</div>
                            ${(()=>{ 
                                const lotesCount = (product.lotes && product.lotes.length) ? product.lotes.length : 0;
                                let existenciasHTML = '';
                                
                                if(product.tipoProducto === 'granel'){
                                    existenciasHTML = `<div style="margin-top:8px; font-size:13px; color:#666;">Factor: ${product.factor || ''} | Lotes: ${lotesCount} | Existencias: ${existencias.piezas.toFixed(3)} Kilos</div>`;
                                } else {
                                    existenciasHTML = `<div style="margin-top:8px; font-size:13px; color:#666;">Factor: ${product.factor || ''} | Lotes: ${lotesCount} | Existencias: ${existencias.cajas} cajas, ${existencias.piezas} piezas</div>`;
                                }
                                
                                // Mostrar informaci贸n de conversi贸n si aplica
                                if ((product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') && product.factor && 
                                    (totalCajasSinConvertir !== existencias.cajas || totalPiezasSinConvertir !== existencias.piezas)) {
                                    existenciasHTML += `
                                        <div class="existencias-conversion">
                                            Conversi贸n: ${totalCajasSinConvertir} cajas, ${totalPiezasSinConvertir} piezas  
                                            ${existencias.cajas} cajas, ${existencias.piezas} piezas
                                        </div>
                                    `;
                                }
                                
                                return existenciasHTML;
                            })()}
                        </div>
                        <div class="family-location-container">
                            <span class="family-tag">${product.familia || 'Sin familia'}</span>
                            ${product.ubicacion ? `<span class="location-tag">Ubicaci贸n: ${product.ubicacion}</span>` : ''}
                            ${statusBadge}
                            ${(()=>{ 
                                try{
                                    const lg = JSON.parse(localStorage.getItem('caducidades_logged_user')) || null;
                                    const canEdit = lg && lg.permisos && (lg.permisos.productosEditar || lg.permisos.productos_edit || lg.permisos.productosEdit || lg.permisos.prod_edit || lg.permisos['productosEditar']);
                                    return canEdit ? `<button class="btn" onclick="editProduct(${originalIndex})" style="margin-left: 8px;">Editar</button>` : '';
                                }catch(e){
                                    return '';
                                }
                            })()}
                        </div>
                    </div>
                    ${product.lotes && product.lotes.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Cajas</th>
                                    <th>${product.tipoProducto === 'granel' ? 'Kilos/Gramos' : 'Piezas'}</th>
                                    <th>Caducidad</th>
                                    <th>Contado</th>
                                    <th>N掳 Compra</th>
                                    <th>Proveedor</th>
                                    <th>Notas</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${product.lotes.map(lote => {
                                    // Calcular conversi贸n para cada lote individual
                                    let conversionRow = '';
                                    if ((product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') && product.factor) {
                                        const cantidadesConvertidas = convertirCantidadesSegunFactor(
                                            lote.cajas, 
                                            lote.piezas, 
                                            product.factor, 
                                            product.tipoProducto
                                        );
                                        
                                        if (lote.cajas !== cantidadesConvertidas.cajas || lote.piezas !== cantidadesConvertidas.piezas) {
                                            conversionRow = `
                                                <tr class="lote-converted">
                                                    <td colspan="8" class="lote-conversion-info">
                                                        Conversi贸n aplicada: ${lote.cajas} cajas, ${lote.piezas} piezas  
                                                        ${cantidadesConvertidas.cajas} cajas, ${cantidadesConvertidas.piezas} piezas (Factor: ${product.factor})
                                                    </td>
                                                </tr>
                                            `;
                                        }
                                    }
                                    
                                    const piezasValue = product.tipoProducto === 'granel' ? 
                                        (parseFloat(lote.piezas) || 0).toFixed(3) : 
                                        lote.piezas || 0;
                                    
                                    return `
                                        <tr>
                                            <td>${lote.cajas || 0}</td>
                                            <td>${piezasValue}</td>
                                            <td>${lote.fecha || 'N/A'}</td>
                                            <td>${lote.contado || 'N/A'}</td>
                                            <td>${lote.numeroCompra || ''}</td>
                                            <td>${lote.proveedor || ''}</td>
                                            <td>${lote.notas || ''}</td>
                                            <td>${lote.fecha ? getExpirationStatus(lote.fecha) : ''}</td>
                                        </tr>
                                        ${conversionRow}
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #666; font-style: italic;">No hay lotes registrados</p>'}
                `;
                inventoryList.appendChild(productEl);
            });
        }

        // Editor de productos
        function populateFamilySelect() {
            const familySelect = document.getElementById('familySelect');
            const families = [...new Set(products.map(p => p.familia))].sort();
            
            familySelect.innerHTML = '<option value="">Seleccionar familia</option>';
            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                familySelect.appendChild(option);
            });
        }

        function nuevoProducto() {
            currentProductIndex = -1;
            editingCodes = [];
            editingLots = [];
            
            document.getElementById('editDesc').value = '';
            document.getElementById('editFactor').value = '';
            document.getElementById('editUbicacion').value = ''; // NUEVO CAMPO
            document.getElementById('editTipoProducto').value = 'piezas';
            document.getElementById('familySelect').value = '';
            document.getElementById('codesList').innerHTML = '';
            document.getElementById('lotsContainer').innerHTML = '';
            
            // Actualizar etiqueta seg煤n tipo de producto
            updatePiezasLabel();
            
            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('deleteBtn').style.display = 'none';
            
            // Desplazarse al editor
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function editProduct(index) {
            currentProductIndex = index;
            const product = products[index];
            
            editingCodes = [...product.codes];
            editingLots = product.lotes ? [...product.lotes] : [];
            
            document.getElementById('editDesc').value = product.descripcion || '';
            document.getElementById('editFactor').value = product.factor || '';
            document.getElementById('editUbicacion').value = product.ubicacion || ''; // NUEVO CAMPO
            document.getElementById('familySelect').value = product.familia || '';
            document.getElementById('editTipoProducto').value = product.tipoProducto || 'piezas';
            
            // Actualizar etiqueta seg煤n tipo de producto
            updatePiezasLabel();
            
            // Render codes
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';
            editingCodes.forEach(code => {
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${code}
                    <span onclick="removeCode('${code.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
            });
            
            // Render lots
            renderLots();
            
            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('deleteBtn').style.display = 'block';
            
            // Desplazarse al editor
            document.getElementById('editorPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function closeEditor() {
            document.getElementById('editorPanel').classList.add('hidden');
        }

        function addCode() {
            const newCodeInput = document.getElementById('newCodeInput');
            const code = newCodeInput.value.trim();
            
            if (code && !editingCodes.includes(code)) {
                editingCodes.push(code);
                
                const codesList = document.getElementById('codesList');
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${code}
                    <span onclick="removeCode('${code.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
                
                newCodeInput.value = '';
            }
        }

        function removeCode(code) {
            editingCodes = editingCodes.filter(c => c !== code);
            
            const codesList = document.getElementById('codesList');
            codesList.innerHTML = '';
            editingCodes.forEach(c => {
                const codePill = document.createElement('div');
                codePill.className = 'code-pill';
                codePill.innerHTML = `
                    ${c}
                    <span onclick="removeCode('${c.replace(/'/g, "\\'")}')"></span>
                `;
                codesList.appendChild(codePill);
            });
        }

        function addFamily() {
            const newFamilyInput = document.getElementById('newFamilyInput');
            const family = newFamilyInput.value.trim();
            
            if (family) {
                const familySelect = document.getElementById('familySelect');
                
                // Check if family already exists
                let exists = false;
                for (let i = 0; i < familySelect.options.length; i++) {
                    if (familySelect.options[i].value === family) {
                        exists = true;
                        break;
                    }
                }
                
                if (!exists) {
                    const option = document.createElement('option');
                    option.value = family;
                    option.textContent = family;
                    familySelect.appendChild(option);
                }
                
                familySelect.value = family;
                newFamilyInput.value = '';
            }
        }

        // Funci贸n MODIFICADA para agregar lote con conversi贸n autom谩tica y mostrar info
        function addLot() {
            const cajasInput = document.getElementById('lot_cajas');
            const piezasInput = document.getElementById('lot_piezas');
            const fecha = document.getElementById('lot_fecha').value;
            const contado = document.getElementById('lot_contado').value;
            const notas = document.getElementById('lot_notas').value;
            const factor = document.getElementById('editFactor').value;
            const tipoProducto = document.getElementById('editTipoProducto').value;
            
            // Obtener valores como n煤meros, permitiendo decimales para productos a granel
            const cajas = tipoProducto === 'granel' ? parseFloat(cajasInput.value) || 0 : parseInt(cajasInput.value) || 0;
            const piezas = tipoProducto === 'granel' ? parseFloat(piezasInput.value) || 0 : parseInt(piezasInput.value) || 0;
            
            if (!fecha) {
                alert('La fecha de caducidad es obligatoria');
                return;
            }
            
            // Guardar valores originales para mostrar la conversi贸n
            const cajasOriginales = cajas;
            const piezasOriginales = piezas;
            
            // Convertir cantidades seg煤n el factor (solo para productos por piezas o caja)
            let cantidadesConvertidas = { cajas, piezas };
            if (tipoProducto === 'piezas' || tipoProducto === 'caja') {
                cantidadesConvertidas = convertirCantidadesSegunFactor(cajas, piezas, factor, tipoProducto);
            }
            
            // Agregar informaci贸n de conversi贸n al lote
            const nuevoLote = {
                cajas: cantidadesConvertidas.cajas,
                piezas: cantidadesConvertidas.piezas,
                cajasOriginales: cajasOriginales,
                piezasOriginales: piezasOriginales,
                fecha: fecha,
                contado: contado,
                notas: notas,
                factor: factor,
                tipoProducto: tipoProducto
            };
            
            editingLots.push(nuevoLote);
            
            // Clear form
            cajasInput.value = '';
            piezasInput.value = '';
            document.getElementById('lot_fecha').value = '';
            document.getElementById('lot_contado').value = '';
            document.getElementById('lot_notas').value = '';
            
            renderLots();
        }

        // Funci贸n MODIFICADA para renderizar lotes mostrando conversi贸n
        function renderLots() {
            const lotsContainer = document.getElementById('lotsContainer');
            lotsContainer.innerHTML = '';
            
            if (editingLots.length === 0) {
                lotsContainer.innerHTML = '<p style="color: #666; font-style: italic;">No hay lotes agregados</p>';
                return;
            }
            
            const tipoProducto = document.getElementById('editTipoProducto').value;
            const factor = document.getElementById('editFactor').value;
            
            editingLots.forEach((lot, index) => {
                const lotRow = document.createElement('div');
                lotRow.className = 'lot-row';
                
                // Formatear el valor para mostrar decimales si es producto a granel
                const piezasValue = tipoProducto === 'granel' ? 
                    (parseFloat(lot.piezas) || 0).toFixed(3) : 
                    (lot.piezas || 0);
                
                // Mostrar informaci贸n de conversi贸n si aplica
                let conversionInfo = '';
                if ((tipoProducto === 'piezas' || tipoProducto === 'caja') && factor && 
                    (lot.cajasOriginales !== lot.cajas || lot.piezasOriginales !== lot.piezas)) {
                    conversionInfo = `
                        <div class="lote-conversion-info">
                            Conversi贸n aplicada: ${lot.cajasOriginales} cajas, ${lot.piezasOriginales} piezas  
                            ${lot.cajas} cajas, ${lot.piezas} piezas (Factor: ${factor})
                        </div>
                    `;
                    lotRow.classList.add('lote-converted');
                }
                
                lotRow.innerHTML = `
                    <div>
                        <label>Cajas</label>
                        <input type="number" value="${lot.cajas || 0}" onchange="updateLotField(${index}, 'cajas', this.value)" step="1" min="0">
                    </div>
                    <div>
                        <label>${tipoProducto === 'granel' ? 'Kilos/Gramos' : 'Piezas'}</label>
                        <input type="number" value="${piezasValue}" onchange="updateLotField(${index}, 'piezas', this.value)" 
                               step="${tipoProducto === 'granel' ? '0.001' : '1'}" min="0">
                    </div>
                    <div>
                        <label>Caducidad</label>
                        <input type="date" value="${lot.fecha || ''}" onchange="updateLotField(${index}, 'fecha', this.value)">
                    </div>
                    <div>
                        <label>Contado</label>
                        <input type="date" value="${lot.contado || ''}" onchange="updateLotField(${index}, 'contado', this.value)">
                    </div>
                    <div>
                        <label>Notas</label>
                        <input type="text" value="${lot.notas || ''}" onchange="updateLotField(${index}, 'notas', this.value)">
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="removeLot(${index})">Eliminar</button>
                    </div>
                    ${conversionInfo}
                `;
                lotsContainer.appendChild(lotRow);
            });
        }

        // Funci贸n: Actualizar campo de lote
        function updateLotField(index, field, value) {
            if (index >= 0 && index < editingLots.length) {
                const tipoProducto = document.getElementById('editTipoProducto').value;
                
                if (field === 'cajas') {
                    editingLots[index][field] = tipoProducto === 'granel' ? parseFloat(value) || 0 : parseInt(value) || 0;
                } else if (field === 'piezas') {
                    editingLots[index][field] = tipoProducto === 'granel' ? parseFloat(value) || 0 : parseInt(value) || 0;
                } else {
                    editingLots[index][field] = value;
                }
            }
        }

        function removeLot(index) {
            editingLots.splice(index, 1);
            renderLots();
        }

        // Funci贸n MODIFICADA para guardar producto - CONVERSIN AUTOMTICA
        function saveProduct() {
            const descripcion = document.getElementById('editDesc').value.trim();
            const familia = document.getElementById('familySelect').value;
            const ubicacion = document.getElementById('editUbicacion').value.trim();
            const factor = document.getElementById('editFactor').value.trim();
            const tipoProducto = document.getElementById('editTipoProducto').value;
            
            if (!descripcion) {
                alert('La descripci贸n es obligatoria');
                return;
            }
            
            if (!familia) {
                alert('La familia es obligatoria');
                return;
            }
            
            if (editingCodes.length === 0) {
                alert('Debe agregar al menos un c贸digo');
                return;
            }
            
            // Convertir cantidades de lotes seg煤n el factor (solo para productos por piezas o caja)
            // y limpiar datos temporales de conversi贸n antes de guardar
            const lotesParaGuardar = editingLots.map(lote => {
                // Crear copia del lote sin datos temporales de conversi贸n
                const { cajasOriginales, piezasOriginales, ...loteLimpio } = lote;
                return loteLimpio;
            });
            
            const productData = {
                codes: editingCodes,
                descripcion: descripcion,
                familia: familia,
                ubicacion: ubicacion,
                factor: factor,
                tipoProducto: tipoProducto,
                lotes: lotesParaGuardar
            };
            
            if (currentProductIndex === -1) {
                // Nuevo producto
                products.push(productData);
            } else {
                // Editar producto existente
                products[currentProductIndex] = productData;
            }
            
            // Guardar en localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            closeEditor();
            
            // OBTENER Y MANTENER EL FILTRO ACTUAL
            const currentFamilyFilter = document.getElementById('familyFilter').value;
            const currentSearchTerm = document.getElementById('globalSearch').value;
            
            renderInventory();
            populateFamilyFilter();
            populateFamilySelect();
            renderDashboard();
            
            // RESTAURAR EL FILTRO DESPUS DE RENDERIZAR
            if (currentFamilyFilter) {
                document.getElementById('familyFilter').value = currentFamilyFilter;
            }
            if (currentSearchTerm) {
                document.getElementById('globalSearch').value = currentSearchTerm;
            }
            
            // VOLVER A APLICAR EL FILTRO
            renderInventory();
            
            // Mostrar notificaci贸n para guardar en Excel
            showSaveNotification('Control_Caducidades.xlsx');
        }

        function deleteProduct() {
            if (currentProductIndex === -1) return;
            
            if (confirm('驴Est谩 seguro de eliminar este producto?')) {
                products.splice(currentProductIndex, 1);
                
                // Guardar en localStorage
                localStorage.setItem('products', JSON.stringify(products));
                
                closeEditor();
                renderInventory();
                populateFamilyFilter();
                populateFamilySelect();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            }
        }

        // Reportes - Renderizado de opciones
        function renderReports() {
            const rangesContainer = document.getElementById('rangesContainer');
            rangesContainer.innerHTML = '';
            
            const ranges = [
                { id: '7days', label: 'Pr贸ximos 1-7 d铆as' },
                { id: '15days', label: 'Pr贸ximos 15 d铆as' },
                { id: '1month', label: '1 mes' },
                { id: '2months', label: '2 meses' },
                { id: '3months', label: '3 meses' },
                { id: '4months', label: '4 meses' },
                { id: '5months', label: '5 meses' },
                { id: '6months', label: '6 meses' },
                { id: '7to9months', label: '7 a 9 meses' },
                { id: '1year', label: '1 a帽o en adelante' },
                { id: 'expired', label: 'Caducados' }
            ];
            
            ranges.forEach(range => {
                const rangeItem = document.createElement('div');
                rangeItem.className = 'range-item';
                rangeItem.innerHTML = `
                    <input type="checkbox" id="${range.id}" onchange="generateReport()">
                    <label for="${range.id}">${range.label}</label>
                `;
                rangesContainer.appendChild(rangeItem);
            });
        }

        function selectAllRanges() {
            document.querySelectorAll('#rangesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            generateReport();
        }

        function clearRanges() {
            document.querySelectorAll('#rangesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            generateReport();
        }

        // Reportes - Generaci贸n
        function generateReport() {
            const reportResult = document.getElementById('reportResult');
            const selectedRanges = [];
            
            // Obtener rangos seleccionados
            document.querySelectorAll('#rangesContainer input[type="checkbox"]:checked').forEach(checkbox => {
                selectedRanges.push(checkbox.id);
            });
            
            if (selectedRanges.length === 0) {
                reportResult.innerHTML = '<div class="card"><p>Seleccione al menos un rango para generar el reporte</p></div>';
                return;
            }
            
            // Calcular fechas de referencia
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizar a inicio del d铆a
            
            const sevenDays = new Date(today);
            sevenDays.setDate(today.getDate() + 7);
            
            const fifteenDays = new Date(today);
            fifteenDays.setDate(today.getDate() + 15);
            
            const oneMonth = new Date(today);
            oneMonth.setMonth(today.getMonth() + 1);
            
            const twoMonths = new Date(today);
            twoMonths.setMonth(today.getMonth() + 2);
            
            const threeMonths = new Date(today);
            threeMonths.setMonth(today.getMonth() + 3);
            
            const fourMonths = new Date(today);
            fourMonths.setMonth(today.getMonth() + 4);
            
            const fiveMonths = new Date(today);
            fiveMonths.setMonth(today.getMonth() + 5);
            
            const sixMonths = new Date(today);
            sixMonths.setMonth(today.getMonth() + 6);
            
            const nineMonths = new Date(today);
            nineMonths.setMonth(today.getMonth() + 9);
            
            const oneYear = new Date(today);
            oneYear.setFullYear(today.getFullYear() + 1);
            
            // Filtrar productos seg煤n los rangos seleccionados
            let filteredProducts = [];
            
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    product.lotes.forEach(lote => {
                        if (lote.fecha) {
                            const expirationDate = new Date(lote.fecha);
                            expirationDate.setHours(0, 0, 0, 0);
                            
                            let includeInReport = false;

                            // Verificar si el lote cumple con alguno de los rangos seleccionados
                            if (selectedRanges.includes('expired') && expirationDate < today) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('7days') && expirationDate >= today && expirationDate <= sevenDays) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('15days') && expirationDate > sevenDays && expirationDate <= fifteenDays) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('1month') && expirationDate > fifteenDays && expirationDate <= oneMonth) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('2months') && expirationDate > oneMonth && expirationDate <= twoMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('3months') && expirationDate > twoMonths && expirationDate <= threeMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('4months') && expirationDate > threeMonths && expirationDate <= fourMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('5months') && expirationDate > fourMonths && expirationDate <= fiveMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('6months') && expirationDate > fiveMonths && expirationDate <= sixMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('7to9months') && expirationDate > sixMonths && expirationDate <= nineMonths) {
                                includeInReport = true;
                            } else if (selectedRanges.includes('1year') && expirationDate > nineMonths) {
                                includeInReport = true;
                            }
                            
                            if (includeInReport) {
                                // Clonar el producto para no modificar el original
                                const productCopy = {...product};
                                productCopy.loteEspecifico = {...lote};
                                filteredProducts.push(productCopy);
                            }
                        }
                    });
                }
            });
            
            // Mostrar resultados
            if (filteredProducts.length === 0) {
                reportResult.innerHTML = '<div class="card"><p>No se encontraron productos en los rangos seleccionados</p></div>';
                return;
            }
            
            let reportHTML = `
                <div class="card">
                    <h3>Resultados del Reporte (${filteredProducts.length} productos)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>C贸digo</th>
                                <th>Descripci贸n</th>
                                <th>Familia</th>
                                <th>Ubicaci贸n</th>
                                <th>Cajas</th>
                                <th>${filteredProducts[0] && filteredProducts[0].tipoProducto === 'granel' ? 'Kilos/Gramos' : 'Piezas'}</th>
                                <th>Caducidad</th>
                                <th>Contado</th>
                                <th>N掳 Compra</th>
                                <th>Proveedor</th>
                                <th>Notas</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredProducts.forEach(product => {
                // MODIFICACIN: Mostrar solo el primer c贸digo en lugar de todos
                const primerCodigo = product.codes.length > 0 ? product.codes[0] : '';
                const piezasValue = product.tipoProducto === 'granel' ? 
                    (parseFloat(product.loteEspecifico.piezas) || 0).toFixed(3) : 
                    product.loteEspecifico.piezas || 0;
                
                reportHTML += `
                    <tr>
                        <td>${primerCodigo}</td>  <!-- Cambiado aqu铆 -->
                        <td>${product.descripcion}</td>
                        <td>${product.familia}</td>
                        <td>${product.ubicacion || ''}</td>
                        <td>${product.loteEspecifico.cajas || 0}</td>
                        <td>${piezasValue}</td>
                        <td>${product.loteEspecifico.fecha || 'N/A'}</td>
                        <td>${product.loteEspecifico.contado || 'N/A'}</td>
                        <td>${product.loteEspecifico.numeroCompra || ''}</td>
                        <td>${product.loteEspecifico.proveedor || ''}</td>
                        <td>${product.loteEspecifico.notas || ''}</td>
                        <td>${product.loteEspecifico.fecha ? getExpirationStatus(product.loteEspecifico.fecha) : ''}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            reportResult.innerHTML = reportHTML;
        }

        function exportReportToExcel() {
            // Primero generar el reporte actual
            generateReport();
            
            // Obtener los datos de la tabla de reportes
            const reportTable = document.querySelector('#reportResult table');
            if (!reportTable) {
                alert('No hay datos para exportar');
                return;
            }
            
            // Convertir la tabla a un libro de Excel
            const wb = XLSX.utils.table_to_book(reportTable);
            
            // Guardar el archivo
            XLSX.writeFile(wb, 'Reporte_Caducidades.xlsx');
        }

        // Importar desde Excel
        function importExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            const format = document.querySelector('input[name="importFormat"]:checked').value;
            
            if (!file) {
                alert('Por favor, seleccione un archivo Excel');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Obtener la primera hoja
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                let jsonData;
                if (format === 'basic') {
                    // Formato b谩sico: C贸digo, Descripci贸n, Factor, Familia
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: ['codigo', 'descripcion', 'factor', 'familia'] 
                    });
                    
                    // Eliminar la primera fila si son encabezados
                    if (jsonData.length > 0 && jsonData[0].codigo === 'C贸digo') {
                        jsonData.shift();
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    
                    // Procesar cada fila
                    jsonData.forEach(row => {
                        if (row.codigo && row.descripcion && row.familia) {
                            const code = String(row.codigo).trim();
                            const descripcion = String(row.descripcion).trim();
                            const factor = String(row.factor || '').trim();
                            const familia = String(row.familia).trim();
                            
                            // Verificar si el producto ya existe por c贸digo
                            const existingIndex = products.findIndex(p => p.codes.includes(code));
                            
                            if (existingIndex !== -1) {
                                // Actualizar producto existente
                                products[existingIndex].descripcion = descripcion;
                                products[existingIndex].factor = factor;
                                products[existingIndex].familia = familia;
                                updatedCount++;
                            } else {
                                // Crear nuevo producto
                                products.push({
                                    codes: [code],
                                    descripcion: descripcion,
                                    factor: factor,
                                    familia: familia,
                                    ubicacion: '', // NUEVO CAMPO
                                    tipoProducto: 'piezas', // Valor por defecto
                                    lotes: []
                                });
                                importedCount++;
                            }
                        }
                    });
                    
                    // Mostrar resultados
                    const importResult = document.getElementById('importResult');
                    importResult.innerHTML = `
                        <div class="import-summary">
                            <h4>Importaci贸n completada (Formato b谩sico)</h4>
                            <p>Productos nuevos: ${importedCount}</p>
                            <p>Productos actualizados: ${updatedCount}</p>
                            <p>Total de productos en sistema: ${products.length}</p>
                        </div>
                    `;
                } else {
                    // Formato completo: C贸digo, Descripci贸n, Factor, Familia, Ubicaci贸n, Tipo Producto, Cajas, Piezas, Fecha Caducidad, Fecha Contado, Notas
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: ['codigo', 'descripcion', 'factor', 'familia', 'ubicacion', 'tipoProducto', 'cajas', 'piezas', 'fechaCaducidad', 'fechaContado', 'notas'] 
                    });
                    
                    // Eliminar la primera fila si son encabezados
                    if (jsonData.length > 0 && jsonData[0].codigo === 'C贸digo') {
                        jsonData.shift();
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let lotesCount = 0;
                    
                    // Procesar cada fila
                    jsonData.forEach(row => {
                        if (row.codigo && row.descripcion && row.familia) {
                            const code = String(row.codigo).trim();
                            const descripcion = String(row.descripcion).trim();
                            const factor = String(row.factor || '').trim();
                            const familia = String(row.familia).trim();
                            const ubicacion = String(row.ubicacion || '').trim();
                            const tipoProducto = String(row.tipoProducto || 'piezas').trim();
                            
                            // Validar tipoProducto - ahora con 3 opciones
                            const tipoValido = (tipoProducto === 'granel' || tipoProducto === 'caja') ? tipoProducto : 'piezas';
                            
                            // Verificar si el producto ya existe por c贸digo
                            const existingIndex = products.findIndex(p => p.codes.includes(code));
                            
                            // Preparar datos del lote
                            const lote = {
                                cajas: parseInt(row.cajas) || 0,
                                piezas: tipoValido === 'granel' ? parseFloat(row.piezas) || 0 : parseInt(row.piezas) || 0,
                                fecha: row.fechaCaducidad || '',
                                contado: row.fechaContado || '',
                                notas: row.notas || ''
                            };
                            
                            if (existingIndex !== -1) {
                                // Actualizar producto existente
                                products[existingIndex].descripcion = descripcion;
                                products[existingIndex].factor = factor;
                                products[existingIndex].familia = familia;
                                products[existingIndex].ubicacion = ubicacion;
                                products[existingIndex].tipoProducto = tipoValido;
                                
                                // Agregar lote si tiene fecha de caducidad
                                if (lote.fecha) {
                                    if (!products[existingIndex].lotes) {
                                        products[existingIndex].lotes = [];
                                    }
                                    products[existingIndex].lotes.push(lote);
                                    lotesCount++;
                                }
                                
                                updatedCount++;
                            } else {
                                // Crear nuevo producto
                                const newProduct = {
                                    codes: [code],
                                    descripcion: descripcion,
                                    factor: factor,
                                    familia: familia,
                                    ubicacion: ubicacion,
                                    tipoProducto: tipoValido,
                                    lotes: []
                                };
                                
                                // Agregar lote si tiene fecha de caducidad
                                if (lote.fecha) {
                                    newProduct.lotes.push(lote);
                                    lotesCount++;
                                }
                                
                                products.push(newProduct);
                                importedCount++;
                            }
                        }
                    });
                    
                    // Mostrar resultados
                    const importResult = document.getElementById('importResult');
                    importResult.innerHTML = `
                        <div class="import-summary">
                            <h4>Importaci贸n completada (Formato completo)</h4>
                            <p>Productos nuevos: ${importedCount}</p>
                            <p>Productos actualizados: ${updatedCount}</p>
                            <p>Lotes importados: ${lotesCount}</p>
                            <p>Total de productos en sistema: ${products.length}</p>
                        </div>
                    `;
                }
                
                // Guardar en localStorage
                localStorage.setItem('products', JSON.stringify(products));
                
                // Actualizar la interfaz
                populateFamilyFilter();
                populateFamilySelect();
                renderInventory();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function clearAllProducts() {
            if (confirm('驴Est谩 seguro de eliminar TODOS los productos? Esta acci贸n no se puede deshacer.')) {
                products = [];
                localStorage.setItem('products', JSON.stringify(products));
                
                // Actualizar la interfaz
                populateFamilyFilter();
                populateFamilySelect();
                renderInventory();
                renderDashboard();
                
                // Mostrar notificaci贸n para guardar en Excel
                showSaveNotification('Control_Caducidades.xlsx');
            }
        }

        
        // Funci贸n para comprobar el uso de almacenamiento local
        function checkStorageUsage() {
            let usedBytes = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    usedBytes += ((localStorage[key].length + key.length) * 2);
                }
            }
            const usedKB = (usedBytes / 1024).toFixed(2);
            const usedMB = (usedBytes / (1024*1024)).toFixed(2);
            const limitMB = 5; // l铆mite estimado para la mayor铆a de navegadores
            const percent = ((usedMB / limitMB) * 100).toFixed(1);
            
            document.getElementById('storageUsageResult').innerText =
                `Uso actual: ${usedKB} KB (${usedMB} MB) / ${limitMB} MB (~${percent}% del l铆mite)`;
        }

        // Funci贸n para mostrar el modal de opciones de guardado
        function showSaveOptions() {
            document.getElementById('saveModal').style.display = 'flex';
        }
        
        // Funci贸n para cerrar el modal de opciones de guardado
        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }
        
        // Funci贸n modificada para guardar en Excel con opciones
        function saveToExcel(mode) {
            closeSaveModal();
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados actualizados
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo Producto', 'Cajas', 'Piezas', 'Fecha Caducidad', 'Fecha Contado', 'N掳 Compra', 'Proveedor', 'Notas']);
            
            // Datos de productos
            products.forEach(product => {
                if (product.lotes && product.lotes.length > 0) {
                    product.lotes.forEach(lote => {
                        dataToExport.push([
                            product.codes.join(', '),
                            product.descripcion,
                            product.familia,
                            product.ubicacion || '', // NUEVO CAMPO
                            product.factor || '',
                            getTipoProductoExportacion(product.tipoProducto),
                            lote.cajas || 0,
                            product.tipoProducto === 'granel' ? (parseFloat(lote.piezas) || 0).toFixed(3) : lote.piezas || 0,
                            lote.fecha || '',
                            lote.contado || '',
                            lote.numeroCompra || '',
                            lote.proveedor || '',
                            lote.notas || ''
                        ]);
                    });
                } else {
                    dataToExport.push([
                        product.codes.join(', '),
                        product.descripcion,
                        product.familia,
                        product.ubicacion || '', // NUEVO CAMPO
                        product.factor || '',
                        getTipoProductoExportacion(product.tipoProducto),
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        ''
                    ]);
                }
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            
            // Determinar el nombre del archivo seg煤n el modo
            let fileName = 'Control_Caducidades.xlsx';
            if (mode === 'new') {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                fileName = `Control_Caducidades_${timestamp}.xlsx`;
            }
            
            // Guardar archivo
            XLSX.writeFile(wb, fileName);
            
            // Mostrar notificaci贸n
            showSaveNotification(fileName);
        }
        
        // Funci贸n para mostrar notificaci贸n de guardado
        function showSaveNotification(fileName) {
            const notification = document.getElementById('saveNotification');
            notification.textContent = `Datos guardados exitosamente en ${fileName}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // ============================================
        // FUNCIONES PARA LA SECCIN DE SURTIDO
        // ============================================
        
        // Funci贸n para poblar el selector de productos en la secci贸n de surtido
        function populateSurtidoProductSelect() {
            const productSelect = document.getElementById('surtidoProductSelect');
            productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            // Guardar referencia a todos los productos para b煤squeda
            allProductsForSurtido = [...products];
            
            products.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${product.descripcion} (${product.codes[0]})`;
                productSelect.appendChild(option);
            });
        }
        
        // Funci贸n para filtrar productos en la secci贸n de surtido
        function filterSurtidoProducts() {
            const searchInput = document.getElementById('surtidoProductSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const productSelect = document.getElementById('surtidoProductSelect');
            
            if (searchTerm === '') {
                populateSurtidoProductSelect();
                return;
            }
            
            // Filtrar productos por c贸digo o descripci贸n
            const filteredProducts = products.filter(product => 
                (product.codes || []).some(code => String(code).toLowerCase().includes(searchTerm)) ||
                (product.descripcion || '').toLowerCase().includes(searchTerm)
            );
            
            productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            filteredProducts.forEach((product, index) => {
                // Encontrar el 铆ndice original en el array products
                const originalIndex = products.indexOf(product);
                const option = document.createElement('option');
                option.value = originalIndex;
                option.textContent = `${product.descripcion} (${product.codes[0]})`;
                productSelect.appendChild(option);
            });
            
            // Si solo hay un resultado, seleccionarlo autom谩ticamente
            if (filteredProducts.length === 1) {
                productSelect.value = products.indexOf(filteredProducts[0]);
                updateSurtidoProductInfo();
            }
        }
        
        // Funci贸n para actualizar la informaci贸n del producto seleccionado
        function updateSurtidoProductInfo() {
            const productSelect = document.getElementById('surtidoProductSelect');
            const productInfo = document.getElementById('surtidoProductInfo');
            const selectedIndex = productSelect.value;
            
            if (selectedIndex === "") {
                productInfo.textContent = "Seleccione un producto para ver su informaci贸n";
                return;
            }
            
            const product = products[selectedIndex];
            
            // Calcular existencias totales CONVERTIDAS - USANDO LA FUNCIN CORREGIDA
            const existencias = calcularExistenciasTotales(product);
            
            // Actualizar inputs de surtido seg煤n el tipo de producto
            updateSurtidoInputs(product.tipoProducto);
            
            productInfo.innerHTML = `
                <strong>${product.descripcion}</strong><br>
                C贸digo: ${product.codes.join(', ')}<br>
                Familia: ${product.familia}<br>
                ${product.ubicacion ? `Ubicaci贸n: ${product.ubicacion}<br>` : ''}
                ${product.factor ? `Factor: ${product.factor}<br>` : ''}
                ${product.tipoProducto ? `Tipo: ${getTipoProductoTexto(product.tipoProducto)}<br>` : ''}
                Existencias: ${existencias.cajas} cajas, ${product.tipoProducto === 'granel' ? existencias.piezas.toFixed(3) : existencias.piezas} ${product.tipoProducto === 'granel' ? 'kilos/gramos' : 'piezas'}<br>
                Lotes disponibles: ${product.lotes ? product.lotes.length : 0}
            `;
        }
        
        // Funci贸n MODIFICADA para agregar un producto a la lista de surtido CON CONVERSIN
        function addToSurtidoList() {
            const productSelect = document.getElementById('surtidoProductSelect');
            const cajasInput = document.getElementById('surtidoCajas');
            const piezasInput = document.getElementById('surtidoPiezas');
            
            const selectedIndex = productSelect.value;
            
            if (selectedIndex === "") {
                alert("Por favor, seleccione un producto");
                return;
            }
            
            const product = products[selectedIndex];
            
            // Obtener valores seg煤n el tipo de producto (enteros o decimales)
            const cajas = product.tipoProducto === 'granel' ? parseFloat(cajasInput.value) || 0 : parseInt(cajasInput.value) || 0;
            const piezas = product.tipoProducto === 'granel' ? parseFloat(piezasInput.value) || 0 : parseInt(piezasInput.value) || 0;
            
            if (cajas === 0 && piezas === 0) {
                alert("Por favor, ingrese al menos una cantidad en cajas o piezas");
                return;
            }
            
            // Convertir cantidades seg煤n el factor (solo para productos por piezas o caja)
            let cantidadesConvertidas = { cajas, piezas };
            if (product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') {
                cantidadesConvertidas = convertirCantidadesSegunFactor(cajas, piezas, product.factor, product.tipoProducto);
            }
            
            // Verificar si ya existe en la lista de surtido
            const existingIndex = surtidoList.findIndex(item => item.productIndex == selectedIndex);
            
            if (existingIndex !== -1) {
                // Actualizar cantidad existente
                surtidoList[existingIndex].cajas += cantidadesConvertidas.cajas;
                surtidoList[existingIndex].piezas += cantidadesConvertidas.piezas;
            } else {
                // Agregar nuevo elemento
                surtidoList.push({
                    productIndex: parseInt(selectedIndex),
                    descripcion: product.descripcion,
                    codigo: product.codes[0],
                    familia: product.familia,
                    ubicacion: product.ubicacion, // NUEVO CAMPO
                    factor: product.factor,
                    tipoProducto: product.tipoProducto,
                    cajas: cantidadesConvertidas.cajas,
                    piezas: cantidadesConvertidas.piezas
                });
            }
            
            // Actualizar la lista visual
            renderSurtidoList();
            
            // Limpiar formulario
            cajasInput.value = 0;
            piezasInput.value = 0;
        }
        
        // Funci贸n para renderizar la lista de surtido
        function renderSurtidoList() {
            const surtidoListElement = document.getElementById('surtidoList');
            
            if (surtidoList.length === 0) {
                surtidoListElement.innerHTML = '<p style="color: #666; font-style: italic;">No hay productos en la lista de surtido</p>';
                return;
            }
            
            let html = '<h4>Productos en lista de surtido</h4>';
            
            surtidoList.forEach((item, index) => {
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    (item.piezas || 0);
                
                html += `
                    <div class="surtido-item">
                        <div>
                            <strong>${item.descripcion}</strong>
                            <div class="lote-info">C贸digo: ${item.codigo} | Familia: ${item.familia} ${item.ubicacion ? `| Ubicaci贸n: ${item.ubicacion}` : ''} ${item.factor ? `| Factor: ${item.factor}` : ''} ${item.tipoProducto ? `| Tipo: ${getTipoProductoTexto(item.tipoProducto)}` : ''}</div>
                        </div>
                        <div>
                            <label>Cajas:</label>
                            <input type="number" value="${item.cajas}" min="0" onchange="updateSurtidoQuantity(${index}, 'cajas', this.value)" step="1">
                        </div>
                        <div>
                            <label>${item.tipoProducto === 'granel' ? 'Kilos/Gramos:' : 'Piezas:'}</label>
                            <input type="number" value="${piezasValue}" min="0" onchange="updateSurtidoQuantity(${index}, 'piezas', this.value)" step="${item.tipoProducto === 'granel' ? '0.001' : '1'}">
                        </div>
                        <div>
                            <label>Estado:</label>
                            <div>${getSurtidoStatus(item.productIndex, item.cajas, item.piezas)}</div>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="removeFromSurtidoList(${index})">Eliminar</button>
                        </div>
                    </div>
                `;
            });
            
            surtidoListElement.innerHTML = html;
        }
        
        // Funci贸n para obtener el estado de surtido de un producto
        function getSurtidoStatus(productIndex, cajas, piezas) {
            const product = products[productIndex];
            
            // Calcular existencias totales CONVERTIDAS - USANDO LA FUNCIN CORREGIDA
            const existencias = calcularExistenciasTotales(product);
            
            if (existencias.cajas >= cajas && existencias.piezas >= piezas) {
                return '<span style="color: green;">Suficiente</span>';
            } else if (existencias.cajas > 0 || existencias.piezas > 0) {
                const piezasDisplay = product.tipoProducto === 'granel' ? existencias.piezas.toFixed(3) : existencias.piezas;
                return `<span style="color: orange;">Insuficiente (${existencias.cajas} cajas, ${piezasDisplay} ${product.tipoProducto === 'granel' ? 'kilos/gramos' : 'piezas'} disponibles)</span>`;
            } else {
                return '<span style="color: red;">Sin existencias</span>';
            }
        }
        
        // Funci贸n MODIFICADA para actualizar la cantidad de un producto en la lista de surtido CON CONVERSIN
        function updateSurtidoQuantity(index, type, newQuantity) {
            const product = products[surtidoList[index].productIndex];
            const cantidad = product.tipoProducto === 'granel' ? parseFloat(newQuantity) : parseInt(newQuantity);
            
            if (isNaN(cantidad) || cantidad < 0) {
                alert("Por favor, ingrese una cantidad v谩lida");
                return;
            }
            
            // Obtener las cantidades actuales
            let cajasActuales = surtidoList[index].cajas;
            let piezasActuales = surtidoList[index].piezas;
            
            // Actualizar el campo espec铆fico
            if (type === 'cajas') {
                cajasActuales = cantidad;
            } else {
                piezasActuales = cantidad;
            }
            
            // Convertir seg煤n el factor si es producto por piezas o caja
            if (product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') {
                const cantidadesConvertidas = convertirCantidadesSegunFactor(
                    cajasActuales, 
                    piezasActuales, 
                    product.factor, 
                    product.tipoProducto
                );
                surtidoList[index].cajas = cantidadesConvertidas.cajas;
                surtidoList[index].piezas = cantidadesConvertidas.piezas;
            } else {
                // Para granel, mantener los valores directos
                surtidoList[index].cajas = cajasActuales;
                surtidoList[index].piezas = piezasActuales;
            }
            
            renderSurtidoList();
        }
        
        // Funci贸n para eliminar un producto de la lista de surtido
        function removeFromSurtidoList(index) {
            surtidoList.splice(index, 1);
            renderSurtidoList();
        }
        
        // Funci贸n para limpiar la lista de surtido
        function clearSurtidoList() {
            if (surtidoList.length === 0) {
                return;
            }
            
            if (confirm("驴Est谩 seguro de que desea limpiar la lista de surtido?")) {
                surtidoList = [];
                renderSurtidoList();
            }
        }
        
        // ============================================
        // FUNCIONES PARA GESTIN DE DESTINOS
        // ============================================
        
        // Funci贸n para renderizar la lista de destinos
        function renderDestinosList() {
            const destinosList = document.getElementById('destinosList');
            destinosList.innerHTML = '';
            
            if (destinos.length === 0) {
                destinosList.innerHTML = '<p style="color: #666; font-style: italic;">No hay destinos configurados</p>';
                return;
            }
            
            destinos.forEach((destino, index) => {
                const destinoPill = document.createElement('div');
                destinoPill.className = 'destino-pill';
                destinoPill.innerHTML = `
                    ${destino}
                    <span onclick="eliminarDestino(${index})"></span>
                `;
                destinosList.appendChild(destinoPill);
            });
        }
        
        // Funci贸n para agregar un nuevo destino
        function agregarDestino() {
            const nuevoDestinoInput = document.getElementById('nuevoDestinoInput');
            const destino = nuevoDestinoInput.value.trim();
            
            if (destino && !destinos.includes(destino)) {
                destinos.push(destino);
                nuevoDestinoInput.value = '';
                
                // Guardar en localStorage
                localStorage.setItem('destinosSurtido', JSON.stringify(destinos));
                
                // Actualizar la lista visual
                renderDestinosList();
                
                // Mostrar notificaci贸n
                showSaveNotification('Destino agregado correctamente');
            } else if (destinos.includes(destino)) {
                alert('Este destino ya existe en la lista');
            }
        }
        
        // Funci贸n para eliminar un destino
        function eliminarDestino(index) {
            if (confirm(`驴Est谩 seguro de eliminar el destino "${destinos[index]}"?`)) {
                destinos.splice(index, 1);
                
                // Guardar en localStorage
                localStorage.setItem('destinosSurtido', JSON.stringify(destinos));
                
                // Actualizar la lista visual
                renderDestinosList();
                
                // Mostrar notificaci贸n
                showSaveNotification('Destino eliminado correctamente');
            }
        }
        
        // Funci贸n para limpiar todos los destinos
        function limpiarDestinos() {
            if (destinos.length === 0) {
                return;
            }
            
            if (confirm('驴Est谩 seguro de eliminar TODOS los destinos? Esta acci贸n no se puede deshacer.')) {
                destinos = [];
                
                // Guardar en localStorage
                localStorage.setItem('destinosSurtido', JSON.stringify(destinos));
                
                // Actualizar la lista visual
                renderDestinosList();
                
                // Mostrar notificaci贸n
                showSaveNotification('Todos los destinos han sido eliminados');
            }
        }
        
        // Funci贸n para filtrar destinos en el autocomplete
        function filterDestinos() {
            const destinoInput = document.getElementById('surtidoDestino');
            const suggestionsContainer = document.getElementById('destinoSuggestions');
            const searchTerm = destinoInput.value.toLowerCase().trim();
            
            suggestionsContainer.innerHTML = '';
            
            if (searchTerm === '') {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const filteredDestinos = destinos.filter(destino => 
                destino.toLowerCase().includes(searchTerm)
            );
            
            if (filteredDestinos.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            filteredDestinos.forEach(destino => {
                const suggestion = document.createElement('div');
                suggestion.className = 'destino-suggestion';
                suggestion.textContent = destino;
                suggestion.onclick = function() {
                    destinoInput.value = destino;
                    suggestionsContainer.style.display = 'none';
                };
                suggestionsContainer.appendChild(suggestion);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        // Funci贸n para mostrar sugerencias de destinos
        function showDestinoSuggestions() {
            const destinoInput = document.getElementById('surtidoDestino');
            const suggestionsContainer = document.getElementById('destinoSuggestions');
            
            if (destinoInput.value === '') {
                // Mostrar todos los destinos si el campo est谩 vac铆o
                suggestionsContainer.innerHTML = '';
                
                destinos.forEach(destino => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'destino-suggestion';
                    suggestion.textContent = destino;
                    suggestion.onclick = function() {
                        destinoInput.value = destino;
                        suggestionsContainer.style.display = 'none';
                    };
                    suggestionsContainer.appendChild(suggestion);
                });
                
                if (destinos.length > 0) {
                    suggestionsContainer.style.display = 'block';
                }
            } else {
                // Filtrar seg煤n lo que ya haya escrito
                filterDestinos();
            }
        }
        
        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            const destinoInput = document.getElementById('surtidoDestino');
            const suggestionsContainer = document.getElementById('destinoSuggestions');
            
            if (e.target !== destinoInput) {
                suggestionsContainer.style.display = 'none';
            }
        });

        // ============================================
        // FUNCIONES MODIFICADAS PARA USAR DESTINOS
        // ============================================
        
        // Funci贸n principal para procesar el surtido (modificada para usar destinos)
        function processSurtido() {
            if (surtidoList.length === 0) {
                alert("No hay productos en la lista de surtido");
                return;
            }
            
            const destinoInput = document.getElementById('surtidoDestino');
            const destino = destinoInput.value.trim();
            
            if (!destino) {
                alert("Por favor, seleccione o ingrese un destino del surtido");
                return;
            }
            
            // Si el destino no existe en la lista, preguntar si desea agregarlo
            if (!destinos.includes(destino)) {
                if (confirm(`驴Desea agregar "${destino}" a la lista de destinos?`)) {
                    destinos.push(destino);
                    localStorage.setItem('destinosSurtido', JSON.stringify(destinos));
                    renderDestinosList();
                }
            }
            
            let resultHTML = '<h4>Resultado del Surtido</h4>';
            let allProcessed = true;
            let processedItems = [];
            
            // Procesar cada producto en la lista de surtido
            surtidoList.forEach(item => {
                const product = products[item.productIndex];
                let remainingCajas = item.cajas;
                let remainingPiezas = item.piezas;
                let lotesUsados = [];
                
                // Ordenar lotes por fecha de caducidad (m谩s pr贸ximos primero)
                const sortedLotes = [...(product.lotes || [])].sort((a, b) => {
                    if (!a.fecha) return 1;
                    if (!b.fecha) return -1;
                    return new Date(a.fecha) - new Date(b.fecha);
                });
                
                // Procesar cada lote hasta satisfacer la cantidad requerida
                for (let i = 0; i < sortedLotes.length && (remainingCajas > 0 || remainingPiezas > 0); i++) {
                    const lote = sortedLotes[i];
                    const cajasEnLote = parseFloat(lote.cajas) || 0;
                    const piezasEnLote = parseFloat(lote.piezas) || 0;
                    
                    if (cajasEnLote > 0 || piezasEnLote > 0) {
                        // Calcular cu谩nto tomar de este lote
                        const cajasATomar = Math.min(remainingCajas, cajasEnLote);
                        const piezasATomar = Math.min(remainingPiezas, piezasEnLote);
                        
                        // Actualizar el lote
                        lote.cajas = Math.max(0, cajasEnLote - cajasATomar);
                        lote.piezas = Math.max(0, piezasEnLote - piezasATomar);
                        
                        // Registrar el lote usado si se tom贸 algo
                        if (cajasATomar > 0 || piezasATomar > 0) {
                            lotesUsados.push({
                                fecha: lote.fecha,
                                cajasTomadas: cajasATomar,
                                piezasTomadas: piezasATomar
                            });
                        }
                        
                        remainingCajas -= cajasATomar;
                        remainingPiezas -= piezasATomar;
                    }
                }
                
                // Eliminar lotes vac铆os
                product.lotes = (product.lotes || []).filter(lote => {
                    const cajas = parseFloat(lote.cajas) || 0;
                    const piezas = parseFloat(lote.piezas) || 0;
                    return cajas > 0 || piezas > 0;
                });
                
                // Registrar el resultado
                processedItems.push({
                    descripcion: product.descripcion,
                    codigo: product.codes[0],
                    familia: product.familia,
                    ubicacion: product.ubicacion, // NUEVO CAMPO
                    factor: product.factor,
                    tipoProducto: product.tipoProducto,
                    cajasSolicitadas: item.cajas,
                    piezasSolicitadas: item.piezas,
                    cajasProcesadas: item.cajas - remainingCajas,
                    piezasProcesadas: item.piezas - remainingPiezas,
                    cajasNoProcesadas: remainingCajas,
                    piezasNoProcesadas: remainingPiezas,
                    lotesUsados: lotesUsados
                });
                
                if (remainingCajas > 0 || remainingPiezas > 0) {
                    allProcessed = false;
                }
            });
            
            // Guardar en el historial
            const surtidoHistorial = {
                fecha: new Date().toISOString(),
                destino: destino,
                items: processedItems,
                completado: allProcessed
            };
            
            historialSurtidos.unshift(surtidoHistorial);
            localStorage.setItem('historialSurtidos', JSON.stringify(historialSurtidos));
            
            // Mostrar resultados
            processedItems.forEach(item => {
                const tieneNoProcesadas = item.cajasNoProcesadas > 0 || item.piezasNoProcesadas > 0;
                const unidad = item.tipoProducto === 'granel' ? 'kilos/gramos' : 'piezas';
                const piezasSolicitadasDisplay = item.tipoProducto === 'granel' ? item.piezasSolicitadas.toFixed(3) : item.piezasSolicitadas;
                const piezasProcesadasDisplay = item.tipoProducto === 'granel' ? item.piezasProcesadas.toFixed(3) : item.piezasProcesadas;
                const piezasNoProcesadasDisplay = item.tipoProducto === 'granel' ? item.piezasNoProcesadas.toFixed(3) : item.piezasNoProcesadas;
                
                resultHTML += `
                    <div class="surtido-result ${tieneNoProcesadas ? 'warning' : ''}">
                        <strong>${item.descripcion}</strong> (${item.codigo})<br>
                        ${item.ubicacion ? `Ubicaci贸n: ${item.ubicacion}<br>` : ''}
                        ${item.factor ? `Factor: ${item.factor}<br>` : ''}
                        ${item.tipoProducto ? `Tipo: ${getTipoProductoTexto(item.tipoProducto)}<br>` : ''}
                        Cantidad solicitada: ${item.cajasSolicitadas} cajas, ${piezasSolicitadasDisplay} ${unidad}<br>
                        Cantidad procesada: ${item.cajasProcesadas} cajas, ${piezasProcesadasDisplay} ${unidad}<br>
                        ${tieneNoProcesadas ? 
                          `<span style="color: orange;">Cantidad no procesada: ${item.cajasNoProcesadas} cajas, ${piezasNoProcesadasDisplay} ${unidad} (insuficiente existencias)</span><br>` : 
                          ''}
                        ${item.lotesUsados.length > 0 ? 
                          `Lotes utilizados:<br>
                           <ul>
                             ${item.lotesUsados.map(lote => {
                                 const piezasTomadasDisplay = item.tipoProducto === 'granel' ? lote.piezasTomadas.toFixed(3) : lote.piezasTomadas;
                                 return `<li>Fecha: ${lote.fecha || 'N/A'}, Cajas: ${lote.cajasTomadas}, ${unidad}: ${piezasTomadasDisplay}</li>`;
                             }).join('')}
                           </ul>` : 
                          'No se utilizaron lotes (sin existencias)'}
                    </div>
                `;
            });
            
            if (allProcessed) {
                resultHTML = `<div class="surtido-result">${resultHTML}</div>`;
            } else {
                resultHTML = `<div class="surtido-result warning">${resultHTML}</div>`;
            }
            
            document.getElementById('surtidoResult').innerHTML = resultHTML;
            
            // Guardar cambios en localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Actualizar la interfaz
            renderInventory();
            populateFamilyFilter();
            populateFamilySelect();
            renderDashboard();
            populateSurtidoProductSelect();
            
            // Limpiar lista de surtido si todo se proces贸 correctamente
            if (allProcessed) {
                surtidoList = [];
                renderSurtidoList();
                destinoInput.value = '';
            }
            
            // Mostrar notificaci贸n para guardar en Excel
            showSaveNotification('Control_Caducidades.xlsx');
        }
        
        // Funci贸n para exportar la lista de surtido a Excel
        function exportSurtidoToExcel() {
            if (surtidoList.length === 0) {
                alert("No hay productos en la lista de surtido para exportar");
                return;
            }
            
            const destino = document.getElementById('surtidoDestino').value || 'Sin destino especificado';
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados
            dataToExport.push(['Lista de Surtido', '', '', '', '']);
            dataToExport.push(['Destino:', destino, '', '', '']);
            dataToExport.push(['Fecha:', new Date().toLocaleDateString(), '', '', '']);
            dataToExport.push([]);
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo Producto', 'Cajas', 'Piezas', 'Estado']);
            
            // Datos de productos en surtido
            surtidoList.forEach(item => {
                const product = products[item.productIndex];
                const estado = getSurtidoStatus(item.productIndex, item.cajas, item.piezas);
                const estadoTexto = estado.includes('Suficiente') ? 'Suficiente' : 
                                  estado.includes('Insuficiente') ? 'Insuficiente' : 'Sin existencias';
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    item.piezas;
                
                dataToExport.push([
                    item.codigo,
                    item.descripcion,
                    item.familia,
                    item.ubicacion || '',
                    item.factor || '',
                    getTipoProductoTexto(item.tipoProducto),
                    item.cajas,
                    piezasValue,
                    estadoTexto
                ]);
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Lista de Surtido');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Lista_Surtido_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // ============================================
        // FUNCIONES PARA EL HISTORIAL DE SURTIDO
        // ============================================
        
        // Funci贸n para renderizar el historial de surtidos
        function renderHistorialSurtido() {
            const historialList = document.getElementById('historialSurtidoList');
            
            // Aplicar filtros
            let historialFiltrado = [...historialSurtidos];
            
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const filtroDestino = document.getElementById('filtroDestino').value.toLowerCase();
            
            if (fechaInicio) {
                historialFiltrado = historialFiltrado.filter(item => 
                    new Date(item.fecha) >= new Date(fechaInicio)
                );
            }
            
            if (fechaFin) {
                const fechaFinObj = new Date(fechaFin);
                fechaFinObj.setHours(23, 59, 59, 999); // Incluir todo el d铆a
                historialFiltrado = historialFiltrado.filter(item => 
                    new Date(item.fecha) <= fechaFinObj
                );
            }
            
            if (filtroDestino) {
                historialFiltrado = historialFiltrado.filter(item => 
                    item.destino.toLowerCase().includes(filtroDestino)
                );
            }
            
            if (historialFiltrado.length === 0) {
                historialList.innerHTML = '<div class="card"><p>No se encontraron surtidos en el historial</p></div>';
                return;
            }
            
            let html = '';
            
            historialFiltrado.forEach((surtido, index) => {
                const fecha = new Date(surtido.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
                
                html += `
                    <div class="card">
                        <div class="historial-header">
                            <div class="historial-fecha">${fechaFormateada}</div>
                            <div class="historial-destino">Destino: ${surtido.destino}</div>
                            <div>
                                <span class="status-badge ${surtido.completado ? 'status-ok' : 'status-warning'}">
                                    ${surtido.completado ? 'COMPLETADO' : 'INCOMPLETO'}
                                </span>
                                <button class="btn" onclick="exportSurtidoIndividualToExcel(${index})">Exportar</button>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>C贸digo</th>
                                    <th>Descripci贸n</th>
                                    <th>Familia</th>
                                    <th>Ubicaci贸n</th>
                                    <th>Factor</th>
                                    <th>Tipo</th>
                                    <th>Cajas Solicitadas</th>
                                    <th>${surtido.items[0] && surtido.items[0].tipoProducto === 'granel' ? 'Kilos/Gramos Solicitados' : 'Piezas Solicitadas'}</th>
                                    <th>Cajas Procesadas</th>
                                    <th>${surtido.items[0] && surtido.items[0].tipoProducto === 'granel' ? 'Kilos/Gramos Procesados' : 'Piezas Procesadas'}</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${surtido.items.map(item => {
                                    const piezasSolicitadasDisplay = item.tipoProducto === 'granel' ? item.piezasSolicitadas.toFixed(3) : item.piezasSolicitadas;
                                    const piezasProcesadasDisplay = item.tipoProducto === 'granel' ? item.piezasProcesadas.toFixed(3) : item.piezasProcesadas;
                                    return `
                                    <tr>
                                        <td>${item.codigo}</td>
                                        <td>${item.descripcion}</td>
                                        <td>${item.familia}</td>
                                        <td>${item.ubicacion || ''}</td>
                                        <td>${item.factor || ''}</td>
                                        <td>${getTipoProductoTexto(item.tipoProducto)}</td>
                                        <td>${item.cajasSolicitadas}</td>
                                        <td>${piezasSolicitadasDisplay}</td>
                                        <td>${item.cajasProcesadas}</td>
                                        <td>${piezasProcesadasDisplay}</td>
                                        <td>${(item.cajasNoProcesadas > 0 || item.piezasNoProcesadas > 0) ? 
                                            '<span style="color: orange;">Incompleto</span>' : 
                                            '<span style="color: green;">Completo</span>'}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            historialList.innerHTML = html;
        }
        
        // Funci贸n para filtrar el historial de surtidos
        function filtrarHistorialSurtido() {
            renderHistorialSurtido();
        }
        
        // Funci贸n para limpiar filtros del historial
        function limpiarFiltrosHistorial() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('filtroDestino').value = '';
            renderHistorialSurtido();
        }
        
        // Funci贸n para exportar el historial completo a Excel
        function exportHistorialSurtidoToExcel() {
            if (historialSurtidos.length === 0) {
                alert("No hay historial de surtidos para exportar");
                return;
            }
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados
            dataToExport.push(['Historial de Surtidos', '', '', '', '', '', '', '']);
            dataToExport.push(['Fecha exportaci贸n:', new Date().toLocaleDateString(), '', '', '', '', '', '']);
            dataToExport.push([]);
            
            // Datos de cada surtido
            historialSurtidos.forEach((surtido, index) => {
                const fecha = new Date(surtido.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
                
                dataToExport.push([`Surtido #${index + 1}`]);
                dataToExport.push(['Fecha:', fechaFormateada]);
                dataToExport.push(['Destino:', surtido.destino]);
                dataToExport.push(['Estado:', surtido.completado ? 'COMPLETADO' : 'INCOMPLETO']);
                dataToExport.push([]);
                dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo', 'Cajas Solicitadas', 'Piezas Solicitadas', 'Cajas Procesadas', 'Piezas Procesadas', 'Estado']);
                
                surtido.items.forEach(item => {
                    const piezasSolicitadasDisplay = item.tipoProducto === 'granel' ? item.piezasSolicitadas.toFixed(3) : item.piezasSolicitadas;
                    const piezasProcesadasDisplay = item.tipoProducto === 'granel' ? item.piezasProcesadas.toFixed(3) : item.piezasProcesadas;
                    dataToExport.push([
                        item.codigo,
                        item.descripcion,
                        item.familia,
                        item.ubicacion || '',
                        item.factor || '',
                        getTipoProductoTexto(item.tipoProducto),
                        item.cajasSolicitadas,
                        piezasSolicitadasDisplay,
                        item.cajasProcesadas,
                        piezasProcesadasDisplay,
                        (item.cajasNoProcesadas > 0 || item.piezasNoProcesadas > 0) ? 'INCOMPLETO' : 'COMPLETO'
                    ]);
                });
                
                dataToExport.push([]);
                dataToExport.push([]);
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Historial Surtidos');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Historial_Surtidos_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // Funci贸n para exportar un surtido individual a Excel
        function exportSurtidoIndividualToExcel(index) {
            const surtido = historialSurtidos[index];
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            const fecha = new Date(surtido.fecha);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
            
            // Encabezados
            dataToExport.push(['Detalle de Surtido', '', '', '', '', '', '', '']);
            dataToExport.push(['Fecha:', fechaFormateada, '', '', '', '', '', '']);
            dataToExport.push(['Destino:', surtido.destino, '', '', '', '', '', '']);
            dataToExport.push(['Estado:', surtido.completado ? 'COMPLETADO' : 'INCOMPLETO', '', '', '', '', '', '']);
            dataToExport.push([]);
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo', 'Cajas Solicitadas', 'Piezas Solicitadas', 'Cajas Procesadas', 'Piezas Procesadas', 'Estado']);
            
            // Datos del surtido
            surtido.items.forEach(item => {
                const piezasSolicitadasDisplay = item.tipoProducto === 'granel' ? item.piezasSolicitadas.toFixed(3) : item.piezasSolicitadas;
                const piezasProcesadasDisplay = item.tipoProducto === 'granel' ? item.piezasProcesadas.toFixed(3) : item.piezasProcesadas;
                dataToExport.push([
                    item.codigo,
                    item.descripcion,
                    item.familia,
                    item.ubicacion || '',
                    item.factor || '',
                    getTipoProductoTexto(item.tipoProducto),
                    item.cajasSolicitadas,
                    piezasSolicitadasDisplay,
                    item.cajasProcesadas,
                    piezasProcesadasDisplay,
                    (item.cajasNoProcesadas > 0 || item.piezasNoProcesadas > 0) ? 'INCOMPLETO' : 'COMPLETO'
                ]);
            });
            
            // Agregar detalles de lotes utilizados
            dataToExport.push([]);
            dataToExport.push(['Lotes Utilizados']);
            dataToExport.push(['Producto', 'Fecha Lote', 'Cajas Tomadas', 'Piezas Tomadas']);
            
            surtido.items.forEach(item => {
                if (item.lotesUsados && item.lotesUsados.length > 0) {
                    item.lotesUsados.forEach(lote => {
                        const piezasTomadasDisplay = item.tipoProducto === 'granel' ? lote.piezasTomadas.toFixed(3) : lote.piezasTomadas;
                        dataToExport.push([
                            item.descripcion,
                            lote.fecha || 'N/A',
                            lote.cajasTomadas,
                            piezasTomadasDisplay
                        ]);
                    });
                }
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Surtido Individual');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Surtido_${surtido.destino.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ============================================
        // FUNCIONES PARA LA SECCIN DE RECIBO DE MERCADERA
        // ============================================

        // Funci贸n para poblar el selector de productos en la secci贸n de recibo
        function populateReciboProductSelect() {
            const productSelect = document.getElementById('reciboProductSelect');
            productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            products.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${product.descripcion} (${product.codes[0]})`;
                productSelect.appendChild(option);
            });
        }

        // Funci贸n para filtrar productos en la secci贸n de recibo
        function filterReciboProducts() {
            const searchInput = document.getElementById('reciboProductSearch');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const productSelect = document.getElementById('reciboProductSelect');
            
            if (searchTerm === '') {
                populateReciboProductSelect();
                return;
            }
            
            // Filtrar productos por c贸digo o descripci贸n
            const filteredProducts = products.filter(product => 
                (product.codes || []).some(code => String(code).toLowerCase().includes(searchTerm)) ||
                (product.descripcion || '').toLowerCase().includes(searchTerm)
            );
            
            productSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            filteredProducts.forEach((product, index) => {
                // Encontrar el 铆ndice original en el array products
                const originalIndex = products.indexOf(product);
                const option = document.createElement('option');
                option.value = originalIndex;
                option.textContent = `${product.descripcion} (${product.codes[0]})`;
                productSelect.appendChild(option);
            });
            
            // Si solo hay un resultado, seleccionarlo autom谩ticamente
            if (filteredProducts.length === 1) {
                productSelect.value = products.indexOf(filteredProducts[0]);
                updateReciboProductInfo();
            }
        }

        // Funci贸n para actualizar la informaci贸n del producto seleccionado en recibo
        function updateReciboProductInfo() {
            const productSelect = document.getElementById('reciboProductSelect');
            const productInfo = document.getElementById('reciboProductInfo');
            const selectedIndex = productSelect.value;
            
            if (selectedIndex === "") {
                productInfo.textContent = "Seleccione un producto para ver su informaci贸n";
                return;
            }
            
            const product = products[selectedIndex];
            
            // Calcular existencias totales CONVERTIDAS - USANDO LA FUNCIN CORREGIDA
            const existencias = calcularExistenciasTotales(product);
            
            // Actualizar inputs de recibo seg煤n el tipo de producto
            const piezasInput = document.getElementById('reciboPiezas');
            if (product.tipoProducto === 'granel') {
                piezasInput.step = '0.001';
            } else {
                piezasInput.step = '1';
            }
            
            productInfo.innerHTML = `
                <strong>${product.descripcion}</strong><br>
                C贸digo: ${product.codes.join(', ')}<br>
                Familia: ${product.familia}<br>
                ${product.ubicacion ? `Ubicaci贸n: ${product.ubicacion}<br>` : ''}
                ${product.factor ? `Factor: ${product.factor}<br>` : ''}
                ${product.tipoProducto ? `Tipo: ${getTipoProductoTexto(product.tipoProducto)}<br>` : ''}
                Existencias actuales: ${existencias.cajas} cajas, ${product.tipoProducto === 'granel' ? existencias.piezas.toFixed(3) : existencias.piezas} ${product.tipoProducto === 'granel' ? 'kilos/gramos' : 'piezas'}
            `;
        }

        // Funci贸n MODIFICADA para agregar un producto a la lista de recibo CON CONVERSIN
        function addToReciboList() {
            const productSelect = document.getElementById('reciboProductSelect');
            const cajasInput = document.getElementById('reciboCajas');
            const piezasInput = document.getElementById('reciboPiezas');
            const fechaCaducidad = document.getElementById('fechaCaducidadRecibo').value;
            
            const selectedIndex = productSelect.value;
            
            if (selectedIndex === "") {
                alert("Por favor, seleccione un producto");
                return;
            }
            
            if (!fechaCaducidad) {
                alert("Por favor, ingrese la fecha de caducidad");
                return;
            }
            
            const product = products[selectedIndex];
            
            // Obtener valores seg煤n el tipo de producto (enteros o decimales)
            const cajas = product.tipoProducto === 'granel' ? parseFloat(cajasInput.value) || 0 : parseInt(cajasInput.value) || 0;
            const piezas = product.tipoProducto === 'granel' ? parseFloat(piezasInput.value) || 0 : parseInt(piezasInput.value) || 0;
            
            if (cajas === 0 && piezas === 0) {
                alert("Por favor, ingrese al menos una cantidad en cajas o piezas");
                return;
            }
            
            // Convertir cantidades seg煤n el factor (solo para productos por piezas o caja)
            let cantidadesConvertidas = { cajas, piezas };
            if (product.tipoProducto === 'piezas' || product.tipoProducto === 'caja') {
                cantidadesConvertidas = convertirCantidadesSegunFactor(cajas, piezas, product.factor, product.tipoProducto);
            }
            
            // Agregar nuevo elemento al recibo
            reciboList.push({
                productIndex: parseInt(selectedIndex),
                descripcion: product.descripcion,
                codigo: product.codes[0],
                familia: product.familia,
                ubicacion: product.ubicacion,
                factor: product.factor,
                tipoProducto: product.tipoProducto,
                cajas: cantidadesConvertidas.cajas,
                piezas: cantidadesConvertidas.piezas,
                cajasOriginales: cajas, // Guardar valores originales para mostrar
                piezasOriginales: piezas, // Guardar valores originales para mostrar
                fechaCaducidad: fechaCaducidad,
                fechaContado: document.getElementById('fechaContadoRecibo').value || '',
                notas: document.getElementById('notasRecibo').value || ''
            });
            
            // Actualizar la lista visual
            renderReciboList();
            
            // Limpiar formulario (excepto n煤mero de compra y proveedor)
            cajasInput.value = 0;
            piezasInput.value = 0;
            document.getElementById('fechaCaducidadRecibo').value = '';
            document.getElementById('fechaContadoRecibo').value = '';
            document.getElementById('notasRecibo').value = '';
            
            // Restablecer el selector de productos
            productSelect.value = "";
            document.getElementById('reciboProductInfo').textContent = "Seleccione un producto para ver su informaci贸n";
        }

        // Funci贸n para renderizar la lista de recibo mostrando conversi贸n
        function renderReciboList() {
            const reciboListElement = document.getElementById('reciboList');
            
            if (reciboList.length === 0) {
                reciboListElement.innerHTML = '<p style="color: #666; font-style: italic;">No hay productos en la lista de recibo</p>';
                return;
            }
            
            let html = '<h4>Productos en lista de recibo</h4>';
            
            reciboList.forEach((item, index) => {
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    (item.piezas || 0);
                
                // Mostrar conversi贸n si aplica
                let conversionInfo = '';
                if ((item.tipoProducto === 'piezas' || item.tipoProducto === 'caja') && item.factor && 
                    (item.cajasOriginales !== item.cajas || item.piezasOriginales !== item.piezas)) {
                    const piezasOriginalesDisplay = item.piezasOriginales;
                    conversionInfo = `
                        <div class="lote-info" style="color: #e65100; font-size: 12px; margin-top: 4px;">
                            Conversi贸n aplicada: ${item.cajasOriginales} cajas, ${piezasOriginalesDisplay} piezas  
                            ${item.cajas} cajas, ${item.piezas} piezas (Factor: ${item.factor})
                        </div>
                    `;
                }
                
                html += `
                    <div class="surtido-item">
                        <div>
                            <strong>${item.descripcion}</strong>
                            <div class="lote-info">C贸digo: ${item.codigo} | Familia: ${item.familia} ${item.ubicacion ? `| Ubicaci贸n: ${item.ubicacion}` : ''}</div>
                            ${conversionInfo}
                        </div>
                        <div>
                            <label>Cajas:</label>
                            <div>${item.cajas}</div>
                        </div>
                        <div>
                            <label>${item.tipoProducto === 'granel' ? 'Kilos/Gramos:' : 'Piezas:'}</label>
                            <div>${piezasValue}</div>
                        </div>
                        <div>
                            <label>Caducidad:</label>
                            <div>${item.fechaCaducidad}</div>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="removeFromReciboList(${index})">Eliminar</button>
                        </div>
                    </div>
                `;
            });
            
            reciboListElement.innerHTML = html;
        }

        // Funci贸n para eliminar un producto de la lista de recibo
        function removeFromReciboList(index) {
            reciboList.splice(index, 1);
            renderReciboList();
        }

        // Funci贸n para limpiar la lista de recibo
        function clearReciboList() {
            if (reciboList.length === 0) {
                return;
            }
            
            if (confirm("驴Est谩 seguro de que desea limpiar la lista de recibo?")) {
                reciboList = [];
                renderReciboList();
            }
        }

        // Funci贸n principal para procesar el recibo (usando cantidades convertidas)
        function processRecibo() {
            if (reciboList.length === 0) {
                alert("No hay productos en la lista de recibo");
                return;
            }
            
            const numeroCompra = document.getElementById('numeroCompra').value.trim();
            const proveedor = document.getElementById('proveedor').value.trim();
            
            if (!numeroCompra) {
                alert("Por favor, ingrese el n煤mero de compra");
                return;
            }
            
            if (!proveedor) {
                alert("Por favor, ingrese el nombre del proveedor");
                return;
            }
            
            let resultHTML = '<h4>Resultado del Recibo</h4>';
            let processedItems = [];
            
            // Procesar cada producto en la lista de recibo
            reciboList.forEach(item => {
                const product = products[item.productIndex];
                
                // Crear nuevo lote con informaci贸n de compra (usando cantidades convertidas)
                const nuevoLote = {
                    cajas: item.cajas, // Usar cantidades convertidas
                    piezas: item.piezas, // Usar cantidades convertidas
                    fecha: item.fechaCaducidad,
                    contado: item.fechaContado,
                    notas: item.notas,
                    numeroCompra: numeroCompra,
                    proveedor: proveedor,
                    fechaRecepcion: new Date().toISOString().split('T')[0]
                };
                
                // Agregar el lote al producto
                if (!product.lotes) {
                    product.lotes = [];
                }
                product.lotes.push(nuevoLote);
                
                // Registrar el resultado
                processedItems.push({
                    descripcion: product.descripcion,
                    codigo: product.codes[0],
                    familia: product.familia,
                    ubicacion: product.ubicacion,
                    factor: product.factor,
                    tipoProducto: product.tipoProducto,
                    cajas: item.cajas,
                    piezas: item.piezas,
                    cajasOriginales: item.cajasOriginales,
                    piezasOriginales: item.piezasOriginales,
                    fechaCaducidad: item.fechaCaducidad,
                    fechaContado: item.fechaContado,
                    notas: item.notas
                });
            });
            
            // Guardar en el historial
            const reciboHistorial = {
                fecha: new Date().toISOString(),
                numeroCompra: numeroCompra,
                proveedor: proveedor,
                items: processedItems
            };
            
            historialRecibos.unshift(reciboHistorial);
            localStorage.setItem('historialRecibos', JSON.stringify(historialRecibos));
            
            // Mostrar resultados
            processedItems.forEach(item => {
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    item.piezas;
                
                // Mostrar conversi贸n si aplica
                let conversionInfo = '';
                if ((item.tipoProducto === 'piezas' || item.tipoProducto === 'caja') && item.factor && 
                    (item.cajasOriginales !== item.cajas || item.piezasOriginales !== item.piezas)) {
                    const piezasOriginalesDisplay = item.piezasOriginales;
                    conversionInfo = `
                        <div style="color: #e65100; font-size: 12px; margin-top: 4px;">
                            <strong>Conversi贸n aplicada:</strong> ${item.cajasOriginales} cajas, ${piezasOriginalesDisplay} piezas  
                            ${item.cajas} cajas, ${item.piezas} piezas (Factor: ${item.factor})
                        </div>
                    `;
                }
                
                resultHTML += `
                    <div class="surtido-result">
                        <strong>${item.descripcion}</strong> (${item.codigo})<br>
                        ${item.ubicacion ? `Ubicaci贸n: ${item.ubicacion}<br>` : ''}
                        ${item.factor ? `Factor: ${item.factor}<br>` : ''}
                        ${item.tipoProducto ? `Tipo: ${getTipoProductoTexto(item.tipoProducto)}<br>` : ''}
                        Cantidad agregada: ${item.cajas} cajas, ${piezasValue} ${item.tipoProducto === 'granel' ? 'kilos/gramos' : 'piezas'}<br>
                        ${conversionInfo}
                        Fecha caducidad: ${item.fechaCaducidad}<br>
                        ${item.fechaContado ? `Fecha contado: ${item.fechaContado}<br>` : ''}
                        ${item.notas ? `Notas: ${item.notas}<br>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('reciboResult').innerHTML = `<div class="surtido-result">${resultHTML}</div>`;
            
            // Guardar cambios en localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Actualizar la interfaz
            renderInventory();
            populateFamilyFilter();
            populateFamilySelect();
            renderDashboard();
            populateReciboProductSelect();
            
            // Limpiar lista de recibo y formulario
            reciboList = [];
            renderReciboList();
            document.getElementById('numeroCompra').value = '';
            document.getElementById('proveedor').value = '';
            document.getElementById('reciboProductSearch').value = '';
            
            // Mostrar notificaci贸n para guardar en Excel
            showSaveNotification('Control_Caducidades.xlsx');
        }

        // Funci贸n para exportar la lista de recibo a Excel
        function exportReciboToExcel() {
            if (reciboList.length === 0) {
                alert("No hay productos en la lista de recibo para exportar");
                return;
            }
            
            const numeroCompra = document.getElementById('numeroCompra').value || 'Sin n煤mero especificado';
            const proveedor = document.getElementById('proveedor').value || 'Sin proveedor especificado';
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados
            dataToExport.push(['Lista de Recibo', '', '', '', '']);
            dataToExport.push(['N煤mero de Compra:', numeroCompra, '', '', '']);
            dataToExport.push(['Proveedor:', proveedor, '', '', '']);
            dataToExport.push(['Fecha:', new Date().toLocaleDateString(), '', '', '']);
            dataToExport.push([]);
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo Producto', 'Cajas', 'Piezas', 'Fecha Caducidad', 'Fecha Contado', 'Notas']);
            
            // Datos de productos en recibo
            reciboList.forEach(item => {
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    item.piezas;
                
                dataToExport.push([
                    item.codigo,
                    item.descripcion,
                    item.familia,
                    item.ubicacion || '',
                    item.factor || '',
                    getTipoProductoTexto(item.tipoProducto),
                    item.cajas,
                    piezasValue,
                    item.fechaCaducidad,
                    item.fechaContado || '',
                    item.notas || ''
                ]);
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Lista de Recibo');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Lista_Recibo_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ============================================
        // FUNCIONES PARA EL HISTORIAL DE RECIBOS
        // ============================================

        // Funci贸n para renderizar el historial de recibos
        function renderHistorialRecibos() {
            const historialList = document.getElementById('historialRecibosList');
            
            // Aplicar filtros
            let historialFiltrado = [...historialRecibos];
            
            const fechaInicio = document.getElementById('fechaInicioRecibo').value;
            const fechaFin = document.getElementById('fechaFinRecibo').value;
            const filtroProveedor = document.getElementById('filtroProveedor').value.toLowerCase();
            const filtroNumeroCompra = document.getElementById('filtroNumeroCompra').value.toLowerCase();
            
            if (fechaInicio) {
                historialFiltrado = historialFiltrado.filter(item => 
                    new Date(item.fecha) >= new Date(fechaInicio)
                );
            }
            
            if (fechaFin) {
                const fechaFinObj = new Date(fechaFin);
                fechaFinObj.setHours(23, 59, 59, 999); // Incluir todo el d铆a
                historialFiltrado = historialFiltrado.filter(item => 
                    new Date(item.fecha) <= fechaFinObj
                );
            }
            
            if (filtroProveedor) {
                historialFiltrado = historialFiltrado.filter(item => 
                    item.proveedor.toLowerCase().includes(filtroProveedor)
                );
            }
            
            if (filtroNumeroCompra) {
                historialFiltrado = historialFiltrado.filter(item => 
                    item.numeroCompra.toLowerCase().includes(filtroNumeroCompra)
                );
            }
            
            if (historialFiltrado.length === 0) {
                historialList.innerHTML = '<div class="card"><p>No se encontraron recibos en el historial</p></div>';
                return;
            }
            
            let html = '';
            
            historialFiltrado.forEach((recibo, index) => {
                const fecha = new Date(recibo.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
                
                html += `
                    <div class="card">
                        <div class="historial-header">
                            <div class="historial-fecha">${fechaFormateada}</div>
                            <div class="historial-destino">Compra: ${recibo.numeroCompra} | Proveedor: ${recibo.proveedor}</div>
                            <div>
                                <button class="btn" onclick="exportReciboIndividualToExcel(${index})">Exportar</button>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>C贸digo</th>
                                    <th>Descripci贸n</th>
                                    <th>Familia</th>
                                    <th>Ubicaci贸n</th>
                                    <th>Factor</th>
                                    <th>Tipo</th>
                                    <th>Cajas</th>
                                    <th>${recibo.items[0] && recibo.items[0].tipoProducto === 'granel' ? 'Kilos/Gramos' : 'Piezas'}</th>
                                    <th>Caducidad</th>
                                    <th>Contado</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recibo.items.map(item => {
                                    const piezasValue = item.tipoProducto === 'granel' ? 
                                        (parseFloat(item.piezas) || 0).toFixed(3) : 
                                        item.piezas;
                                    return `
                                    <tr>
                                        <td>${item.codigo}</td>
                                        <td>${item.descripcion}</td>
                                        <td>${item.familia}</td>
                                        <td>${item.ubicacion || ''}</td>
                                        <td>${item.factor || ''}</td>
                                        <td>${getTipoProductoTexto(item.tipoProducto)}</td>
                                        <td>${item.cajas}</td>
                                        <td>${piezasValue}</td>
                                        <td>${item.fechaCaducidad}</td>
                                        <td>${item.fechaContado || ''}</td>
                                        <td>${item.notas || ''}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            historialList.innerHTML = html;
        }

        // Funci贸n para filtrar el historial de recibos
        function filtrarHistorialRecibos() {
            renderHistorialRecibos();
        }

        // Funci贸n para limpiar filtros del historial de recibos
        function limpiarFiltrosHistorialRecibos() {
            document.getElementById('fechaInicioRecibo').value = '';
            document.getElementById('fechaFinRecibo').value = '';
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('filtroNumeroCompra').value = '';
            document.getElementById('proveedorSuggestions').style.display = 'none';
            renderHistorialRecibos();
        }

        // Funci贸n para exportar el historial completo de recibos a Excel
        function exportHistorialRecibosToExcel() {
            if (historialRecibos.length === 0) {
                alert("No hay historial de recibos para exportar");
                return;
            }
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            // Encabezados
            dataToExport.push(['Historial de Recibos', '', '', '', '', '', '', '']);
            dataToExport.push(['Fecha exportaci贸n:', new Date().toLocaleDateString(), '', '', '', '', '', '']);
            dataToExport.push([]);
            
            // Datos de cada recibo
            historialRecibos.forEach((recibo, index) => {
                const fecha = new Date(recibo.fecha);
                const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
                
                dataToExport.push([`Recibo #${index + 1}`]);
                dataToExport.push(['Fecha:', fechaFormateada]);
                dataToExport.push(['N煤mero de Compra:', recibo.numeroCompra]);
                dataToExport.push(['Proveedor:', recibo.proveedor]);
                dataToExport.push([]);
                dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo', 'Cajas', 'Piezas', 'Fecha Caducidad', 'Fecha Contado', 'Notas']);
                
                recibo.items.forEach(item => {
                    const piezasValue = item.tipoProducto === 'granel' ? 
                        (parseFloat(item.piezas) || 0).toFixed(3) : 
                        item.piezas;
                    dataToExport.push([
                        item.codigo,
                        item.descripcion,
                        item.familia,
                        item.ubicacion || '',
                        item.factor || '',
                        getTipoProductoTexto(item.tipoProducto),
                        item.cajas,
                        piezasValue,
                        item.fechaCaducidad,
                        item.fechaContado || '',
                        item.notas || ''
                    ]);
                });
                
                dataToExport.push([]);
                dataToExport.push([]);
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Historial Recibos');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Historial_Recibos_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Funci贸n para exportar un recibo individual a Excel
        function exportReciboIndividualToExcel(index) {
            const recibo = historialRecibos[index];
            
            // Preparar datos para exportar
            const dataToExport = [];
            
            const fecha = new Date(recibo.fecha);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
            
            // Encabezados
            dataToExport.push(['Detalle de Recibo', '', '', '', '', '', '', '']);
            dataToExport.push(['Fecha:', fechaFormateada, '', '', '', '', '', '']);
            dataToExport.push(['N煤mero de Compra:', recibo.numeroCompra, '', '', '', '', '', '']);
            dataToExport.push(['Proveedor:', recibo.proveedor, '', '', '', '', '', '']);
            dataToExport.push([]);
            dataToExport.push(['C贸digo', 'Descripci贸n', 'Familia', 'Ubicaci贸n', 'Factor', 'Tipo', 'Cajas', 'Piezas', 'Fecha Caducidad', 'Fecha Contado', 'Notas']);
            
            // Datos del recibo
            recibo.items.forEach(item => {
                const piezasValue = item.tipoProducto === 'granel' ? 
                    (parseFloat(item.piezas) || 0).toFixed(3) : 
                    item.piezas;
                dataToExport.push([
                    item.codigo,
                    item.descripcion,
                    item.familia,
                    item.ubicacion || '',
                    item.factor || '',
                    getTipoProductoTexto(item.tipoProducto),
                    item.cajas,
                    piezasValue,
                    item.fechaCaducidad,
                    item.fechaContado || '',
                    item.notas || ''
                ]);
            });
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            
            // A帽adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Recibo Individual');
            
            // Guardar archivo
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Recibo_${recibo.numeroCompra.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ============================================
        // FUNCIONES PARA EL AUTOCOMPLETE DE PROVEEDORES
        // ============================================

        // Funci贸n para obtener proveedores 煤nicos del historial
        function getProveedoresUnicos() {
            const proveedores = new Set();
            historialRecibos.forEach(recibo => {
                if (recibo.proveedor && recibo.proveedor.trim() !== '') {
                    proveedores.add(recibo.proveedor.trim());
                }
            });
            return Array.from(proveedores).sort();
        }

        // Funci贸n para filtrar proveedores en el autocomplete
        function filterProveedores() {
            const proveedorInput = document.getElementById('filtroProveedor');
            const suggestionsContainer = document.getElementById('proveedorSuggestions');
            const searchTerm = proveedorInput.value.toLowerCase().trim();
            
            suggestionsContainer.innerHTML = '';
            
            if (searchTerm === '') {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const proveedores = getProveedoresUnicos();
            const filteredProveedores = proveedores.filter(proveedor => 
                proveedor.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProveedores.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            filteredProveedores.forEach(proveedor => {
                const suggestion = document.createElement('div');
                suggestion.className = 'proveedor-suggestion';
                suggestion.textContent = proveedor;
                suggestion.onclick = function() {
                    proveedorInput.value = proveedor;
                    suggestionsContainer.style.display = 'none';
                    filtrarHistorialRecibos();
                };
                suggestionsContainer.appendChild(suggestion);
            });
            
            suggestionsContainer.style.display = 'block';
        }

        // Funci贸n para mostrar sugerencias de proveedores
        function showProveedorSuggestions() {
            const proveedorInput = document.getElementById('filtroProveedor');
            const suggestionsContainer = document.getElementById('proveedorSuggestions');
            
            if (proveedorInput.value === '') {
                // Mostrar todos los proveedores si el campo est谩 vac铆o
                suggestionsContainer.innerHTML = '';
                
                const proveedores = getProveedoresUnicos();
                proveedores.forEach(proveedor => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'proveedor-suggestion';
                    suggestion.textContent = proveedor;
                    suggestion.onclick = function() {
                        proveedorInput.value = proveedor;
                        suggestionsContainer.style.display = 'none';
                        filtrarHistorialRecibos();
                    };
                    suggestionsContainer.appendChild(suggestion);
                });
                
                if (proveedores.length > 0) {
                    suggestionsContainer.style.display = 'block';
                }
            } else {
                // Filtrar seg煤n lo que ya haya escrito
                filterProveedores();
            }
        }

        // Ocultar sugerencias de proveedores al hacer clic fuera
        document.addEventListener('click', function(e) {
            const proveedorInput = document.getElementById('filtroProveedor');
            const suggestionsContainer = document.getElementById('proveedorSuggestions');
            
            if (e.target !== proveedorInput) {
                suggestionsContainer.style.display = 'none';
            }
        });
    </script>

<script>
// Permission protection and UI adjustments for "Nuevo Producto" and edit actions
(function(){
    function hasProductEditPerm(){
        try{
            const lg = JSON.parse(localStorage.getItem('caducidades_logged_user') || 'null');
            if(!lg || !lg.permisos) return false;
            const p = lg.permisos;
            return !!(p.productosEditar || p.productos_edit || p.productosEdit || p.prod_edit || p.productosEditar === true || p.productos === true || p.productosEditar === true);
        }catch(e){
            return false;
        }
    }

    function hideNuevoButtonIfNeeded(){
        const canEdit = hasProductEditPerm();
        // Find buttons that likely are "Nuevo Producto"
        const buttons = Array.from(document.querySelectorAll('button'));
        buttons.forEach(b=>{
            const txt = (b.textContent || '').trim();
            if(/nuevo\s*producto/i.test(txt) || /\+\s*nuevo\s*producto/i.test(txt)){
                if(!canEdit) b.style.display='none';
            }
        });
        // Also try elements with classes that include 'new' or 'nuevo'
        const candidates = Array.from(document.querySelectorAll('[id],[class]'));
        candidates.forEach(el=>{
            try{
                const id = el.id || '';
                const cls = el.className || '';
                if(/nuevo-producto|nuevoProducto|btn-new-product|new-product|crear-producto/i.test(id) || /nuevo-producto|nuevoProducto|btn-new-product|new-product|crear-producto/i.test(cls)){
                    if(!canEdit) el.style.display='none';
                }
            }catch(e){}
        });
    }

    // Wrap potentially dangerous functions to enforce permission check
    const protectedNames = ['nuevoProducto','editProduct','deleteProduct','editarLote','editarExistencias','eliminarProducto','removeProduct','deleteProductById'];
    protectedNames.forEach(name=>{
        try{
            if(typeof window[name] === 'function'){
                const original = window[name];
                window[name] = function(...args){
                    if(!hasProductEditPerm()){
                        alert('No tienes permiso para realizar esta acci贸n.');
                        return;
                    }
                    return original.apply(this,args);
                };
            } else {
                // define a guarded stub to prevent calls if function not yet defined
                window[name] = function(...args){
                    if(!hasProductEditPerm()){
                        alert('No tienes permiso para realizar esta acci贸n.');
                        return;
                    }
                    // if original defined later, this stub will be overwritten by subsequent scripts
                };
            }
        }catch(e){}
    });

    // Also hide inline edit buttons that may have been rendered without permission (extra safety)
    function hideInlineEditButtons(){
        const canEdit = hasProductEditPerm();
        const buttons = Array.from(document.querySelectorAll('button'));
        buttons.forEach(b=>{
            const txt = (b.textContent || '').trim().toLowerCase();
            if(txt === 'editar' || /editar\s*producto/i.test(txt)){
                if(!canEdit) b.style.display='none';
            }
        });
    }

    // Run on load and also when login modal closes (in case of immediate change)
    window.addEventListener('load', function(){
        hideNuevoButtonIfNeeded();
        hideInlineEditButtons();
    });
    // Also expose a function to re-check (useful after login)
    window.enforceProductEditVisibility = function(){
        hideNuevoButtonIfNeeded();
        hideInlineEditButtons();
    };
})();
</script>


<!-- IMPORT MODULES: SheetJS and PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>

<script>
(function(){
  // Keys used in the system
  const USERS_KEY = 'caducidades_users_v1';
  const PRODUCTS_KEY = 'caducidades_products_v1'; // adapt if your system uses different key
  const LOGGED_KEY = 'caducidades_logged_user';
  const DEST_KEY = 'destinosSurtido';

  function loadUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY)) || []; } catch(e){ return []; } }
  function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
  function loadDestinos(){ try{ return JSON.parse(localStorage.getItem(DEST_KEY)) || ['Tienda 1','Tienda 2','Bodega Central','Sucursal Norte','Sucursal Sur']; }catch(e){ return ['Tienda 1','Tienda 2','Bodega Central','Sucursal Norte','Sucursal Sur']; } }
  function saveDestinos(d){ localStorage.setItem(DEST_KEY, JSON.stringify(d)); }

  function ensureDefaultAdmin(){
      let users = loadUsers();
      if(!users || users.length===0){
          users=[{id:1, username:'admin', password:'1234', active:true, isAdmin:true, permisos:{}}];
          saveUsers(users);
      } else if(!users.some(x=>x.isAdmin)){
          users[0].isAdmin=true; users[0].active=true; users[0].permisos = {};
          saveUsers(users);
      }
  }

  function getLogged(){ try{ return JSON.parse(localStorage.getItem(LOGGED_KEY)); }catch(e){return null;} }
  function setLogged(u){ if(u) localStorage.setItem(LOGGED_KEY, JSON.stringify(u)); else localStorage.removeItem(LOGGED_KEY); }

  window.handleLogin = function(){
      const user = document.getElementById('loginUserVisual').value.trim();
      const pass = document.getElementById('loginPassVisual').value;
      const err = document.getElementById('loginErrorVisual');
      err.style.display='none';
      const users = loadUsers();
      const found = users.find(x=>x.username===user);
      if(!found){ err.textContent='Usuario no encontrado'; err.style.display='block'; return; }
      if(!found.active){ err.textContent='Usuario inactivo'; err.style.display='block'; return; }
      if(found.password !== pass){ err.textContent='Contrase帽a incorrecta'; err.style.display='block'; return; }
      setLogged({ id: found.id, username: found.username, isAdmin: !!found.isAdmin, permisos: found.permisos });
      document.getElementById('loginModalVisual').style.display='none';
      applyPermissionsVisual();
      showSection('dashboard');
  };

  window.handleLogout = function(){ setLogged(null); window.location.reload(); };

  function applyPermissionsVisual(){
      const logged = getLogged();
      const btns = { 
          inicio: document.getElementById('btnInicio'), 
          productos: document.getElementById('btnProductos'), 
          surtido: document.getElementById('btnSurtido'), 
          recibo: document.getElementById('btnRecibo'),
          reportes: document.getElementById('btnReportes'), 
          historial: document.getElementById('btnHistorial'), 
          historialRecibos: document.getElementById('btnHistorialRecibos'),
          importar: document.getElementById('btnImportar'), 
          configuracion: document.getElementById('btnConfiguracion'), 
          save: document.getElementById('btnSaveExcel'), 
          logout: document.getElementById('btnLogout') 
      };
      
      Object.values(btns).forEach(b=>{ if(b) b.style.display='none'; });
      if(!logged) return;
      
      const users = loadUsers();
      const me = users.find(u=>u.id===logged.id);
      if(!me){ setLogged(null); document.getElementById('loginModalVisual').style.display='flex'; return; }
      
      const perms = me.permisos || {};
      
      // SI ES ADMIN, MOSTRAR TODOS LOS BOTONES SIN IMPORTAR LOS PERMISOS
      if (me.isAdmin) {
          if(btns.inicio) btns.inicio.style.display='inline-block';
          if(btns.productos) btns.productos.style.display='inline-block';
          if(btns.surtido) btns.surtido.style.display='inline-block';
          if(btns.recibo) btns.recibo.style.display='inline-block';
          if(btns.reportes) btns.reportes.style.display='inline-block';
          if(btns.historial) btns.historial.style.display='inline-block';
          if(btns.historialRecibos) btns.historialRecibos.style.display='inline-block';
          if(btns.importar) btns.importar.style.display='inline-block';
          if(btns.configuracion) btns.configuracion.style.display='inline-block';
          if(btns.save) btns.save.style.display='inline-block';
          if(btns.logout) btns.logout.style.display='inline-block';
      } else {
          // PARA USUARIOS NO ADMIN, APLICAR PERMISOS NORMALMENTE
          if(perms.inicio && btns.inicio) btns.inicio.style.display='inline-block';
          if(perms.productos && btns.productos) btns.productos.style.display='inline-block';
          if(perms.surtido && btns.surtido) btns.surtido.style.display='inline-block';
          if(perms.recibo && btns.recibo) btns.recibo.style.display='inline-block';
          if(perms.reportes && btns.reportes) btns.reportes.style.display='inline-block';
          if(perms.historial && btns.historial) btns.historial.style.display='inline-block';
          if(perms.recibo && btns.historialRecibos) btns.historialRecibos.style.display='inline-block';
          if(perms.importar && btns.importar) btns.importar.style.display='inline-block';
          if(perms.configuracion && btns.configuracion) btns.configuracion.style.display='inline-block';
          
          if((perms.productos||perms.reportes||perms.importar||perms.configuracion||perms.recibo) && btns.save) btns.save.style.display='inline-block';
          if(btns.logout) btns.logout.style.display='inline-block';
      }
      
      const usersCard = document.getElementById('usersManagementCardVisual'); 
      if(usersCard) usersCard.style.display = (me.isAdmin || perms.configuracion) ? 'block' : 'none';
      const destCard = document.getElementById('destinosConfigCardVisual'); 
      if(destCard) destCard.style.display = (me.isAdmin || perms.configuracion) ? 'block' : 'none';
  }

  // Users table and modal handlers (same as prior implementation)
  window.renderUsersTableVisual = function(){
      const container = document.getElementById('usersTableContainerVisual'); if(!container) return;
      const users = loadUsers();
      if(users.length===0){ container.innerHTML='<p>No hay usuarios.</p>'; return; }
      let html = '<table style="width:100%; border-collapse:collapse;"><thead><tr><th>ID</th><th>Usuario</th><th>Activo</th><th>Admin</th><th>Permisos</th><th>Acciones</th></tr></thead><tbody>';
      users.forEach(u=>{ html += '<tr>'; html += '<td>'+u.id+'</td>'; html += '<td>'+u.username+'</td>'; html += '<td>'+(u.active?'':'')+'</td>'; html += '<td>'+(u.isAdmin?'':'')+'</td>'; html += '<td>'+Object.keys(u.permisos||{}).filter(k=>u.permisos[k]).join(', ')+'</td>'; html += '<td><button class="btn" onclick="openEditUserModalVisual('+u.id+')">Editar</button> <button class="btn btn-danger" onclick="confirmDeleteUserVisual('+u.id+')">Eliminar</button></td>'; html += '</tr>'; });
      html += '</tbody></table>'; container.innerHTML = html;
  };
  window.openCreateUserModal = function(){ 
      document.getElementById('userModalTitle').textContent='Crear Usuario'; 
      document.getElementById('um_username').value=''; 
      document.getElementById('um_password').value=''; 
      document.getElementById('um_estado').value='activo'; 
      document.getElementById('um_tipo').value='usuario'; 
      
      // HABILITAR TODOS LOS CHECKBOXES Y PONERLOS EN TRUE POR DEFECTO
      const checkboxes = [
          'perm_inicio', 'perm_prod_ver', 'perm_prod_edit', 'perm_surtido', 
          'perm_recibo', 'perm_reportes', 'perm_historial', 'perm_importar', 'perm_config'
      ];
      
      checkboxes.forEach(checkboxId => {
          const checkbox = document.getElementById(checkboxId);
          checkbox.disabled = false;
          checkbox.checked = true;
      });
      
      document.getElementById('um_delete_btn').style.display='none'; 
      document.getElementById('userModalVisual').style.display='flex'; 
      document.getElementById('userModalVisual').dataset.editing = ''; 
  };
  window.openEditUserModalVisual = function(id){ 
      const users = loadUsers(); 
      const u = users.find(x=>x.id===id); 
      if(!u) return alert('Usuario no encontrado'); 
      document.getElementById('userModalTitle').textContent='Editar Usuario'; 
      document.getElementById('um_username').value=u.username; 
      document.getElementById('um_password').value=''; 
      document.getElementById('um_estado').value = u.active? 'activo':'inactivo'; 
      document.getElementById('um_tipo').value = u.isAdmin? 'admin':'usuario'; 
      
      // SI ES ADMIN, DESHABILITAR LOS CHECKBOXES DE PERMISOS
      const isAdmin = u.isAdmin;
      const checkboxes = [
          'perm_inicio', 'perm_prod_ver', 'perm_prod_edit', 'perm_surtido', 
          'perm_recibo', 'perm_reportes', 'perm_historial', 'perm_importar', 'perm_config'
      ];
      
      checkboxes.forEach(checkboxId => {
          const checkbox = document.getElementById(checkboxId);
          checkbox.disabled = isAdmin;
          if (isAdmin) {
              checkbox.checked = true;
          } else {
              checkbox.checked = !!u.permisos[checkboxId.replace('perm_', '')];
          }
      });
      
      document.getElementById('um_delete_btn').style.display='inline-block'; 
      document.getElementById('userModalVisual').style.display='flex'; 
      document.getElementById('userModalVisual').dataset.editing = String(id); 
  };
  window.closeUserModal = function(){ document.getElementById('userModalVisual').style.display='none'; };
  window.saveUserFromModal = function(){ 
      const editing = document.getElementById('userModalVisual').dataset.editing; 
      const username = document.getElementById('um_username').value.trim(); 
      const password = document.getElementById('um_password').value; 
      const estado = document.getElementById('um_estado').value; 
      const tipo = document.getElementById('um_tipo').value; 
      
      if(!username) return alert('El usuario es obligatorio'); 
      
      let users = loadUsers(); 
      if(editing){ 
          const id = Number(editing); 
          const u = users.find(x=>x.id===id); 
          if(!u) return alert('Usuario no encontrado'); 
          
          u.username = username; 
          if(password) u.password = password; 
          u.active = (estado === 'activo'); 
          u.isAdmin = (tipo === 'admin'); 
          
          // SI ES ADMIN, NO GUARDAR PERMISOS ESPECFICOS (TIENE TODOS)
          if (u.isAdmin) {
              u.permisos = {};
          } else {
              u.permisos = { 
                  inicio: !!document.getElementById('perm_inicio').checked, 
                  productos: !!document.getElementById('perm_prod_ver').checked, 
                  productosEditar: !!document.getElementById('perm_prod_edit').checked, 
                  surtido: !!document.getElementById('perm_surtido').checked, 
                  recibo: !!document.getElementById('perm_recibo').checked, 
                  reportes: !!document.getElementById('perm_reportes').checked, 
                  historial: !!document.getElementById('perm_historial').checked, 
                  importar: !!document.getElementById('perm_importar').checked, 
                  configuracion: !!document.getElementById('perm_config').checked 
              }; 
          }
      } else { 
          users = loadUsers(); 
          const maxId = users.reduce((m,u)=> Math.max(m, u.id||0), 0); 
          const newId = maxId + 1; 
          const isAdminUser = (tipo === 'admin');
          const newUser = { 
              id: newId, 
              username: username, 
              password: password || '1234', 
              active: (estado === 'activo'), 
              isAdmin: isAdminUser,
              permisos: isAdminUser ? {} : { 
                  inicio: !!document.getElementById('perm_inicio').checked, 
                  productos: !!document.getElementById('perm_prod_ver').checked, 
                  productosEditar: !!document.getElementById('perm_prod_edit').checked, 
                  surtido: !!document.getElementById('perm_surtido').checked, 
                  recibo: !!document.getElementById('perm_recibo').checked, 
                  reportes: !!document.getElementById('perm_reportes').checked, 
                  historial: !!document.getElementById('perm_historial').checked, 
                  importar: !!document.getElementById('perm_importar').checked, 
                  configuracion: !!document.getElementById('perm_config').checked 
              } 
          }; 
          users.push(newUser); 
      } 
      
      saveUsers(users); 
      closeUserModal(); 
      renderUsersTableVisual(); 
      applyPermissionsVisual(); 
      alert('Usuario guardado'); 
  };
  window.deleteUserFromModal = function(){ 
      const editing = document.getElementById('userModalVisual').dataset.editing; 
      if(!editing) return; 
      if(!confirm('Eliminar usuario? Esta acci贸n es irreversible')) return; 
      let users = loadUsers(); 
      const idx = users.findIndex(x=>x.id===Number(editing)); 
      if(idx===-1) return alert('Usuario no encontrado'); 
      if(users[idx].isAdmin){ 
          const adminCount = users.filter(u=>u.isAdmin).length; 
          if(adminCount<=1) return alert('No se puede eliminar al 煤nico administrador.'); 
      } 
      users.splice(idx,1); 
      saveUsers(users); 
      closeUserModal(); 
      renderUsersTableVisual(); 
      applyPermissionsVisual(); 
  };
  window.confirmDeleteUserVisual = function(id){ 
      if(!confirm('Eliminar usuario con ID ' + id + '?')) return; 
      let users = loadUsers(); 
      const idx = users.findIndex(x=>x.id===id); 
      if(idx===-1) return alert('Usuario no encontrado'); 
      if(users[idx].isAdmin){ 
          const adminCount = users.filter(u=>u.isAdmin).length; 
          if(adminCount<=1) return alert('No se puede eliminar al 煤nico administrador.'); 
      } 
      users.splice(idx,1); 
      saveUsers(users); 
      renderUsersTableVisual(); 
      applyPermissionsVisual(); 
  };

  // destinos visual
  window.renderDestinosConfigListVisual = function(){ 
      const container = document.getElementById('destinosConfigListVisual'); 
      if(!container) return; 
      const list = loadDestinos(); 
      if(list.length===0){ container.innerHTML='<p>No hay destinos registrados.</p>'; return; } 
      let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;">'; 
      list.forEach((d,i)=> html += `<div class="destino-pill" style="background:#eef;padding:8px 12px;border-radius:20px;">${d} <button class="btn" style="margin-left:8px;" onclick="eliminarDestinoDesdeConfigVisual(${i})">Eliminar</button></div>`); 
      html += '</div>'; 
      container.innerHTML = html; 
  };
  window.agregarDestinoDesdeConfigVisual = function(){ 
      const input = document.getElementById('nuevoDestinoConfigInputVisual'); 
      if(!input) return; 
      const val = input.value.trim(); 
      if(!val) return alert('Ingrese un destino'); 
      const list = loadDestinos(); 
      if(list.includes(val)) return alert('Destino ya existe'); 
      list.push(val); 
      saveDestinos(list); 
      input.value=''; 
      renderDestinosConfigListVisual(); 
      populateSurtidoDestinosVisual(); 
  };
  window.eliminarDestinoDesdeConfigVisual = function(idx){ 
      if(!confirm('Eliminar destino?')) return; 
      const list = loadDestinos(); 
      if(idx<0||idx>=list.length) return; 
      list.splice(idx,1); 
      saveDestinos(list); 
      renderDestinosConfigListVisual(); 
      populateSurtidoDestinosVisual(); 
  };
  window.limpiarDestinosConfigVisual = function(){ 
      if(!confirm('Eliminar todos los destinos?')) return; 
      saveDestinos([]); 
      renderDestinosConfigListVisual(); 
      populateSurtidoDestinosVisual(); 
  };
  window.populateSurtidoDestinosVisual = function(){ 
      const list = loadDestinos(); 
      const suggestionsEl = document.getElementById('destinoSuggestions'); 
      if(suggestionsEl){ 
          suggestionsEl.innerHTML=''; 
          list.forEach(d=>{ 
              const div = document.createElement('div'); 
              div.className='destino-suggestion'; 
              div.textContent=d; 
              div.onclick = function(){ 
                  const inp = document.getElementById('surtidoDestino'); 
                  if(inp) inp.value = d; 
                  suggestionsEl.style.display='none'; 
              }; 
              suggestionsEl.appendChild(div); 
          }); 
      } 
      const selt = document.getElementById('surtidoDestinoSelect'); 
      if(selt){ 
          selt.innerHTML = '<option value="">Seleccionar destino...</option>'; 
          list.forEach(d=>{ 
              const opt = document.createElement('option'); 
              opt.value=d; 
              opt.text=d; 
              selt.appendChild(opt); 
          }); 
      } 
  };

  window.addEventListener('load', function(){ 
      ensureDefaultAdmin(); 
      renderUsersTableVisual(); 
      renderDestinosConfigListVisual(); 
      populateSurtidoDestinosVisual(); 
      const logged = getLogged(); 
      if(!logged){ 
          document.getElementById('loginModalVisual').style.display='flex'; 
      } else { 
          document.getElementById('loginModalVisual').style.display='none'; 
      } 
      applyPermissionsVisual(); 
  });
})();
</script>

<!-- ============================================
GESTIN DE TIPOS DE USUARIO PERSONALIZADOS
============================================ -->

<script>
// Tipos de usuario por defecto
const TIPOS_USUARIO_KEY = 'caducidades_tipos_usuario';
const tiposUsuarioPorDefecto = ['admin', 'usuario', 'compras', 'almacen', 'inventarios'];

// Cargar tipos de usuario desde localStorage
function loadTiposUsuario() {
    try {
        const tiposGuardados = localStorage.getItem(TIPOS_USUARIO_KEY);
        return tiposGuardados ? JSON.parse(tiposGuardados) : tiposUsuarioPorDefecto;
    } catch (e) {
        return tiposUsuarioPorDefecto;
    }
}

// Guardar tipos de usuario en localStorage
function saveTiposUsuario(tipos) {
    localStorage.setItem(TIPOS_USUARIO_KEY, JSON.stringify(tipos));
}

// Agregar nuevo tipo de usuario
function agregarNuevoTipoUsuario() {
    const input = document.getElementById('nuevoTipoUsuarioInput');
    const nuevoTipo = input.value.trim().toLowerCase();
    
    if (!nuevoTipo) {
        alert('Por favor, ingrese un nombre para el nuevo tipo de usuario');
        return;
    }
    
    const tiposUsuario = loadTiposUsuario();
    
    if (tiposUsuario.includes(nuevoTipo)) {
        alert('Este tipo de usuario ya existe');
        return;
    }
    
    tiposUsuario.push(nuevoTipo);
    saveTiposUsuario(tiposUsuario);
    
    // Actualizar el select
    populateTiposUsuarioSelect();
    
    // Seleccionar el nuevo tipo
    document.getElementById('um_tipo').value = nuevoTipo;
    
    // Limpiar el input
    input.value = '';
    
    alert(`Tipo de usuario "${nuevoTipo}" agregado correctamente`);
}

// Poblar el select de tipos de usuario
function populateTiposUsuarioSelect() {
    const select = document.getElementById('um_tipo');
    const tiposUsuario = loadTiposUsuario();
    
    select.innerHTML = '';
    
    tiposUsuario.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1); // Capitalizar
        select.appendChild(option);
    });
}

// Eliminar tipo de usuario
function eliminarTipoUsuario(tipo) {
    if (tipo === 'admin' || tipo === 'usuario') {
        alert('No se puede eliminar los tipos "admin" y "usuario" por defecto');
        return;
    }
    
    if (!confirm(`驴Est谩 seguro de eliminar el tipo de usuario "${tipo}"?`)) {
        return;
    }
    
    const tiposUsuario = loadTiposUsuario();
    const nuevosTipos = tiposUsuario.filter(t => t !== tipo);
    saveTiposUsuario(nuevosTipos);
    
    populateTiposUsuarioSelect();
    renderTiposUsuarioList();
    
    alert(`Tipo de usuario "${tipo}" eliminado correctamente`);
}

// Renderizar lista de tipos de usuario en configuraci贸n
function renderTiposUsuarioList() {
    const container = document.getElementById('tiposUsuarioList');
    if (!container) return;
    
    const tiposUsuario = loadTiposUsuario();
    
    let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">';
    
    tiposUsuario.forEach(tipo => {
        const puedeEliminar = !(tipo === 'admin' || tipo === 'usuario');
        html += `
            <div class="destino-pill" style="background:#f0f8ff;padding:8px 12px;border-radius:20px;">
                ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}
                ${puedeEliminar ? 
                    `<button class="btn" style="margin-left:8px;padding:2px 8px;font-size:12px;" onclick="eliminarTipoUsuario('${tipo}')">Eliminar</button>` : 
                    '<span style="margin-left:8px;color:#999;font-size:12px;">(Por defecto)</span>'
                }
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Funci贸n para agregar tipo de usuario desde la configuraci贸n
function agregarTipoUsuarioDesdeConfig() {
    const input = document.getElementById('nuevoTipoUsuarioConfigInput');
    const nuevoTipo = input.value.trim().toLowerCase();
    
    if (!nuevoTipo) {
        alert('Por favor, ingrese un nombre para el nuevo tipo de usuario');
        return;
    }
    
    const tiposUsuario = loadTiposUsuario();
    
    if (tiposUsuario.includes(nuevoTipo)) {
        alert('Este tipo de usuario ya existe');
        return;
    }
    
    tiposUsuario.push(nuevoTipo);
    saveTiposUsuario(tiposUsuario);
    
    // Actualizar las listas
    populateTiposUsuarioSelect();
    renderTiposUsuarioList();
    
    // Limpiar el input
    input.value = '';
    
    alert(`Tipo de usuario "${nuevoTipo}" agregado correctamente`);
}

// Modificar la funci贸n openCreateUserModal para incluir tipos de usuario
const originalOpenCreateUserModal = window.openCreateUserModal;
window.openCreateUserModal = function() {
    originalOpenCreateUserModal();
    populateTiposUsuarioSelect();
    document.getElementById('um_tipo').value = 'usuario'; // Valor por defecto
};

// Modificar la funci贸n openEditUserModalVisual para incluir tipos de usuario
const originalOpenEditUserModalVisual = window.openEditUserModalVisual;
window.openEditUserModalVisual = function(id) {
    originalOpenEditUserModalVisual(id);
    populateTiposUsuarioSelect();
    
    // Cargar el tipo del usuario que se est谩 editando
    const users = loadUsers();
    const user = users.find(u => u.id === id);
    if (user && user.tipo) {
        document.getElementById('um_tipo').value = user.tipo;
    }
};

// Modificar la funci贸n saveUserFromModal para manejar tipos personalizados
const originalSaveUserFromModal = window.saveUserFromModal;
window.saveUserFromModal = function() {
    const editing = document.getElementById('userModalVisual').dataset.editing;
    const tipoSeleccionado = document.getElementById('um_tipo').value;
    
    let users = loadUsers();
    
    if (editing) {
        // Editar usuario existente
        const id = Number(editing);
        const userIndex = users.findIndex(x => x.id === id);
        if (userIndex !== -1) {
            users[userIndex].tipo = tipoSeleccionado;
        }
    } else {
        // Crear nuevo usuario - el tipo ya se guarda en la l贸gica original
        // Solo necesitamos asegurarnos de que el 煤ltimo usuario tenga el tipo correcto
        if (users.length > 0) {
            users[users.length - 1].tipo = tipoSeleccionado;
        }
    }
    
    saveUsers(users);
    originalSaveUserFromModal();
};

// Inicializar tipos de usuario al cargar la p谩gina
document.addEventListener('DOMContentLoaded', function() {
    // Asegurarse de que existan los tipos por defecto
    const tiposActuales = loadTiposUsuario();
    if (tiposActuales.length === 0) {
        saveTiposUsuario(tiposUsuarioPorDefecto);
    }
    
    populateTiposUsuarioSelect();
    renderTiposUsuarioList();
});
</script>

</body>
</html>